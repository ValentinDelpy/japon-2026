<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Little Domo Very Arigato â€” Japon 2026</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@1,400;1,500&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:        #f0ede8;
  --surface:   #faf8f5;
  --surface2:  #f4f1ec;
  --border:    #e2ddd6;
  --border2:   #cdc7be;
  --sage:      #7a9e8e;
  --sage-l:    #e8f0ec;
  --blush:     #c47e7e;
  --blush-l:   #f5e8e8;
  --sky:       #7a9bb5;
  --sky-l:     #e8eff5;
  --amber:     #b8924a;
  --amber-l:   #f5eedf;
  --lavender:  #9a8ab5;
  --lavender-l:#f0edf7;
  --ink:       #2a2520;
  --ink2:      #5a524a;
  --ink3:      #8a8078;
  --snow:      #fdfcfa;
  --panel:     360px;
  --hdr:       60px;
  --radius:    14px;
  --radius-sm: 8px;
}

[data-theme="dark"] {
  --bg:        #1a1714;
  --surface:   #211e1b;
  --surface2:  #2a2622;
  --border:    #3a3530;
  --border2:   #4a4540;
  --sage:      #8ab5a0;
  --sage-l:    #1e2e28;
  --blush:     #d4908f;
  --blush-l:   #2e1f1f;
  --sky:       #8aafc8;
  --sky-l:     #1a2535;
  --amber:     #c8a460;
  --amber-l:   #2a2010;
  --lavender:  #b0a0c8;
  --lavender-l:#221a30;
  --ink:       #f0ece8;
  --ink2:      #c8c0b8;
  --ink3:      #8a8278;
  --snow:      #2a2622;
}

html, body { height: 100%; overflow: hidden; }
body { font-family: 'Outfit', sans-serif; color: var(--ink); display: flex; flex-direction: column; background: var(--bg); transition: background 0.3s, color 0.3s; }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  height: var(--hdr); flex-shrink: 0;
  display: flex; align-items: center; padding: 0 16px; gap: 10px;
  background: var(--snow); border-bottom: 1px solid var(--border);
  z-index: 400; transition: background 0.3s, border-color 0.3s;
}
.logo { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.logo-kanji { font-family: 'Shippori Mincho', serif; font-size: 1.4rem; color: var(--blush); line-height: 1; }
.logo-text { display: flex; flex-direction: column; gap: 1px; }
.logo-main { font-family: 'Shippori Mincho', serif; font-size: 0.88rem; font-weight: 600; color: var(--ink); letter-spacing: 0.04em; }
.logo-sub { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.72rem; color: var(--ink3); letter-spacing: 0.06em; }
.hdr-sep { width: 1px; height: 26px; background: var(--border); flex-shrink: 0; }
.hdr-spacer { flex: 1; min-width: 0; }

/* Compte Ã  rebours */
.hdr-countdown {
  display: flex; flex-direction: column; align-items: center;
  background: var(--blush-l); border: 1px solid rgba(196,126,126,0.25);
  border-radius: 20px; padding: 4px 12px; flex-shrink: 0;
  cursor: default;
}
.countdown-days { font-family: 'Shippori Mincho', serif; font-size: 1rem; font-weight: 700; color: var(--blush); line-height: 1; }
.countdown-label { font-size: 0.48rem; color: var(--ink3); letter-spacing: 0.08em; text-transform: uppercase; }

/* Mode "on est au Japon" */
.hdr-countdown.live {
  background: var(--sage-l); border-color: rgba(122,158,142,0.3);
}
.hdr-countdown.live .countdown-days { color: var(--sage); }

/* Taux de change */
.hdr-fx {
  display: flex; align-items: center; gap: 5px;
  background: var(--amber-l); border: 1px solid rgba(184,146,74,0.2);
  border-radius: 20px; padding: 4px 10px; font-size: 0.6rem;
  color: var(--amber); letter-spacing: 0.04em; flex-shrink: 0;
  cursor: pointer; transition: all 0.2s; position: relative;
}
.hdr-fx:hover { background: var(--amber); color: white; }
.fx-rate { font-weight: 600; }

/* Weather */
.hdr-weather {
  display: flex; align-items: center; gap: 6px;
  background: var(--sage-l); border: 1px solid rgba(122,158,142,0.25);
  border-radius: 20px; padding: 5px 10px; font-size: 0.6rem;
  color: var(--sage); letter-spacing: 0.05em; cursor: pointer;
  flex-shrink: 0; position: relative; transition: all 0.2s;
}
.hdr-weather:hover { background: var(--sage); color: white; }
.weather-temp { font-weight: 600; margin-left: 2px; }

/* Weather dropdown */
.weather-dropdown {
  position: absolute; top: calc(100% + 10px); right: 0;
  width: 310px; background: var(--snow);
  border: 1.5px solid var(--border); border-radius: var(--radius);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
  z-index: 500; overflow: hidden;
  opacity: 0; pointer-events: none; transform: translateY(-8px);
  transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
}
.weather-dropdown.open { opacity: 1; pointer-events: all; transform: translateY(0); }
.weather-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid var(--border); scrollbar-width: none; }
.weather-tabs::-webkit-scrollbar { display: none; }
.weather-tab { flex-shrink: 0; padding: 8px 11px; font-size: 0.52rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--ink3); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; white-space: nowrap; }
.weather-tab.active { color: var(--sage); border-color: var(--sage); }
.weather-panels { padding: 12px; }
.weather-panel { display: none; }
.weather-panel.active { display: block; }
.weather-city-name { font-family: 'Shippori Mincho', serif; font-size: 0.95rem; font-weight: 700; color: var(--ink); margin-bottom: 2px; }
.weather-city-period { font-size: 0.55rem; color: var(--ink3); letter-spacing: 0.05em; margin-bottom: 10px; }
.weather-forecast { display: flex; gap: 4px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.weather-forecast::-webkit-scrollbar { display: none; }
.wf-day { flex-shrink: 0; width: 62px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 7px 5px; text-align: center; transition: all 0.15s; cursor: default; }
.wf-day:hover { background: var(--snow); border-color: var(--border2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.07); }
.wf-day-name { font-size: 0.48rem; color: var(--ink3); letter-spacing: 0.06em; margin-bottom: 3px; }
.wf-icon { font-size: 1rem; margin-bottom: 3px; }
.wf-max { font-size: 0.68rem; font-weight: 600; color: var(--ink); }
.wf-min { font-size: 0.54rem; color: var(--ink3); }
.wf-rain { font-size: 0.44rem; color: var(--sky); margin-top: 2px; }
.weather-summary { margin-top: 10px; padding: 8px 10px; background: var(--sage-l); border-radius: var(--radius-sm); font-size: 0.57rem; color: var(--ink2); line-height: 1.6; }
.weather-source { font-size: 0.46rem; color: var(--ink3); margin-top: 6px; text-align: right; }

/* Dots */
.hdr-progress { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.progress-label { font-size: 0.56rem; color: var(--ink3); letter-spacing: 0.08em; text-transform: uppercase; white-space: nowrap; }
.progress-dots { display: flex; gap: 4px; align-items: center; }
.pdot { width: 7px; height: 7px; border-radius: 50%; transition: all 0.3s; cursor: pointer; border: none; }
.pdot.active { transform: scale(1.4); }

/* Icon buttons */
.hdr-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 50%; width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
  flex-shrink: 0; color: var(--ink2);
}
.hdr-btn:hover { background: var(--blush-l); border-color: var(--blush); }

.btn-toggle {
  display: none; background: var(--surface2); border: 1px solid var(--border);
  color: var(--ink2); padding: 6px 12px; font-family: 'Outfit', sans-serif;
  font-size: 0.62rem; letter-spacing: 0.06em; cursor: pointer;
  border-radius: 20px; transition: all 0.2s; flex-shrink: 0;
  align-items: center; gap: 6px;
}
.btn-toggle:hover { background: var(--blush-l); border-color: var(--blush); color: var(--blush); }

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex: 1; display: flex; overflow: hidden; }
#map { flex: 1; min-width: 0; z-index: 1; }

/* â”€â”€â”€ MINIMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#minimap {
  position: absolute; bottom: 80px; left: 10px;
  width: 130px; height: 100px;
  border: 2px solid var(--border); border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 100; overflow: hidden;
  transition: opacity 0.3s;
}

/* Nav prev/next */
.map-nav {
  position: absolute; bottom: 20px; left: 50%;
  transform: translateX(-50%);
  display: flex; gap: 8px; z-index: 100;
}
.map-nav-btn {
  background: var(--snow); border: 1.5px solid var(--border);
  border-radius: 20px; padding: 7px 16px;
  font-family: 'Outfit', sans-serif; font-size: 0.62rem;
  font-weight: 500; letter-spacing: 0.06em;
  color: var(--ink2); cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 6px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}
.map-nav-btn:hover { background: var(--blush-l); border-color: var(--blush); color: var(--blush); }
.map-nav-btn:disabled { opacity: 0.3; cursor: default; pointer-events: none; }
.map-nav-btn.current-stop {
  background: var(--blush); border-color: var(--blush); color: white;
  font-weight: 600;
}

/* â”€â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  width: var(--panel); flex-shrink: 0;
  display: flex; flex-direction: column;
  background: var(--surface); border-left: 1px solid var(--border);
  overflow: hidden; transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), background 0.3s;
}

.panel-hdr {
  padding: 12px 16px 10px; border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

/* View tabs */
.view-tabs {
  display: flex; gap: 4px; margin-bottom: 8px;
}
.view-tab {
  flex: 1; padding: 5px 0; text-align: center;
  font-size: 0.56rem; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--ink3); cursor: pointer; border-radius: 8px;
  border: 1px solid transparent; transition: all 0.15s;
}
.view-tab.active { background: var(--blush-l); color: var(--blush); border-color: rgba(196,126,126,0.2); }
.view-tab:hover:not(.active) { background: var(--surface2); }

.panel-meta { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
.panel-title { font-family: 'Shippori Mincho', serif; font-size: 0.95rem; font-weight: 600; color: var(--ink); margin-bottom: 2px; }
.panel-sub { font-size: 0.56rem; color: var(--ink3); letter-spacing: 0.06em; }
.budget-pill { background: var(--amber-l); border: 1px solid rgba(184,146,74,0.25); border-radius: 20px; padding: 4px 10px; text-align: right; flex-shrink: 0; }
.budget-amount { font-family: 'Shippori Mincho', serif; font-size: 0.82rem; font-weight: 600; color: var(--amber); display: block; }
.budget-label { font-size: 0.5rem; color: var(--ink3); letter-spacing: 0.06em; }

/* â”€â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.view-pane { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.view-pane.active { display: flex; }

/* â”€â”€â”€ LIST VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scroll {
  flex: 1; overflow-y: auto; padding: 10px;
  display: flex; flex-direction: column; gap: 7px;
  scrollbar-width: thin; scrollbar-color: var(--border2) transparent;
}
.sep { display: flex; align-items: center; gap: 8px; padding: 3px 2px; }
.sep-line { flex: 1; height: 1px; background: var(--border); }
.sep-chip { display: flex; align-items: center; gap: 5px; background: var(--sky-l); border: 1px solid rgba(122,155,181,0.2); border-radius: 20px; padding: 3px 10px; font-size: 0.52rem; color: var(--sky); letter-spacing: 0.07em; text-transform: uppercase; white-space: nowrap; }

/* â”€â”€â”€ STOP CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stop-card {
  background: var(--snow); border: 1.5px solid var(--border);
  border-radius: var(--radius);
  transition: border-color 0.2s, box-shadow 0.2s;
  cursor: pointer;
  animation: slideIn 0.45s cubic-bezier(0.22,1,0.36,1) both;
  position: relative;
}
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.stop-card:hover { border-color: var(--border2); box-shadow: 0 4px 20px rgba(0,0,0,0.07); }
.stop-card.active { border-color: var(--blush); box-shadow: 0 6px 28px rgba(196,126,126,0.15); }
/* "On est lÃ " mode */
.stop-card.current-stay { border-color: var(--sage); box-shadow: 0 6px 28px rgba(122,158,142,0.2); }
.stop-card.current-stay::before {
  content: 'ğŸ“ On est lÃ  !';
  position: absolute; top: -10px; left: 14px;
  background: var(--sage); color: white;
  font-size: 0.48rem; font-weight: 600; letter-spacing: 0.08em;
  padding: 2px 8px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(122,158,142,0.4);
}

.card-strip { height: 4px; border-radius: var(--radius) var(--radius) 0 0; }
.card-head-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; padding: 12px 13px 9px; cursor: pointer; user-select: none; }
.card-num-city { flex: 1; min-width: 0; }
.card-num { font-size: 0.48rem; font-weight: 600; letter-spacing: 0.16em; text-transform: uppercase; margin-bottom: 2px; opacity: 0.6; }
.card-city { font-family: 'Shippori Mincho', serif; font-size: 1.02rem; font-weight: 700; color: var(--ink); line-height: 1.2; }
.card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.card-dates { font-size: 0.56rem; color: var(--ink3); letter-spacing: 0.04em; text-align: right; line-height: 1.5; }
.card-expand-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.62rem; color: var(--ink3); transition: all 0.2s; flex-shrink: 0; user-select: none; }
.stop-card.active .card-expand-btn { background: var(--blush-l); border-color: rgba(196,126,126,0.3); color: var(--blush); }
.card-expand-btn .arrow { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: inline-block; }
.stop-card.expanded .card-expand-btn .arrow { transform: rotate(180deg); }

.card-quick { display: flex; align-items: center; gap: 5px; padding: 0 13px 10px; flex-wrap: wrap; }
.quick-chip { display: flex; align-items: center; gap: 4px; font-size: 0.55rem; padding: 3px 7px; border-radius: 20px; letter-spacing: 0.03em; white-space: nowrap; }

/* Expandable body */
.card-body { max-height: 0; overflow: hidden; transition: max-height 0.42s cubic-bezier(0.4,0,0.2,1); }
.stop-card.expanded .card-body { max-height: 9000px; transition: max-height 0.6s cubic-bezier(0.4,0,0.2,1); }
.card-body-inner { border-top: 1px solid var(--border); margin: 0 13px; padding: 11px 0 14px; display: flex; flex-direction: column; gap: 10px; }

/* Lodging */
.lodge-title { font-size: 0.5rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink3); margin-bottom: 5px; }
.lodge-options { display: flex; flex-direction: column; gap: 5px; }
.lodge-option { display: flex; align-items: center; gap: 7px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 10px; text-decoration: none; transition: all 0.18s; color: var(--ink); }
.lodge-option:hover { border-color: var(--border2); background: var(--snow); transform: translateX(2px); }
.lodge-option.main-opt { border-left: 3px solid var(--sage); }
.lodge-option.alt-opt  { border-left: 3px solid var(--lavender); opacity: 0.8; }
.lodge-option.alt-opt:hover { opacity: 1; }
.lodge-badge { font-size: 0.48rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; padding: 2px 5px; border-radius: 4px; flex-shrink: 0; }
.badge-main { background: var(--sage-l); color: var(--sage); }
.badge-alt  { background: var(--lavender-l); color: var(--lavender); }
.lodge-name { font-size: 0.64rem; font-weight: 500; color: var(--ink2); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lodge-price { font-size: 0.6rem; font-weight: 600; color: var(--amber); flex-shrink: 0; }
.lodge-arrow { font-size: 0.6rem; color: var(--ink3); flex-shrink: 0; }

/* Details */
.detail-row { display: flex; gap: 7px; align-items: flex-start; }
.detail-icon { width: 24px; height: 24px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.78rem; flex-shrink: 0; }
.detail-content { flex: 1; min-width: 0; }
.detail-label { font-size: 0.48rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 1px; }
.detail-value { font-size: 0.62rem; color: var(--ink2); line-height: 1.6; }

.activity-pills { display: flex; flex-wrap: wrap; gap: 5px; }
.activity-pill { background: var(--sage-l); border: 1px solid rgba(122,158,142,0.2); border-radius: 20px; padding: 3px 9px; font-size: 0.57rem; color: var(--sage); letter-spacing: 0.04em; }

.guide-link { display: inline-flex; align-items: center; gap: 5px; font-size: 0.57rem; color: var(--sky); text-decoration: none; border: 1px solid rgba(122,155,181,0.25); border-radius: 20px; padding: 3px 9px; background: var(--sky-l); transition: all 0.15s; width: fit-content; }
.guide-link:hover { background: var(--sky); color: white; border-color: var(--sky); }

/* â”€â”€â”€ CALENDAR VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calendar-view {
  flex: 1; overflow-y: auto; padding: 12px 10px;
  scrollbar-width: thin; scrollbar-color: var(--border2) transparent;
}
.cal-month { margin-bottom: 16px; }
.cal-month-title { font-family: 'Shippori Mincho', serif; font-size: 0.85rem; font-weight: 700; color: var(--ink); margin-bottom: 8px; padding: 0 2px; display: flex; align-items: center; gap: 8px; }
.cal-month-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.cal-days { display: flex; flex-direction: column; gap: 3px; }
.cal-day {
  display: flex; align-items: stretch; min-height: 32px;
  border-radius: 8px; overflow: hidden; cursor: pointer;
  transition: all 0.15s;
}
.cal-day:hover { transform: translateX(2px); }
.cal-day-num { width: 42px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--surface2); padding: 4px; }
.cal-day-num .num { font-family: 'Shippori Mincho', serif; font-size: 0.9rem; font-weight: 700; color: var(--ink); line-height: 1; }
.cal-day-num .dow { font-size: 0.44rem; color: var(--ink3); letter-spacing: 0.06em; text-transform: uppercase; margin-top: 1px; }
.cal-day-bar { flex: 1; display: flex; align-items: center; padding: 4px 10px; gap: 8px; border-left: 3px solid transparent; }
.cal-day.has-stop .cal-day-bar { background: var(--snow); }
.cal-day.transit .cal-day-bar { background: var(--sky-l); border-color: var(--sky); }
.cal-day.travel .cal-day-bar { background: var(--surface2); opacity: 0.6; }
.cal-stop-city { font-family: 'Shippori Mincho', serif; font-size: 0.82rem; font-weight: 700; color: var(--ink); }
.cal-stop-meta { font-size: 0.5rem; color: var(--ink3); }
.cal-stop-badge { font-size: 0.5rem; padding: 2px 7px; border-radius: 20px; letter-spacing: 0.04em; flex-shrink: 0; margin-left: auto; }
.cal-day.current-day .cal-day-num { background: var(--blush); }
.cal-day.current-day .cal-day-num .num,
.cal-day.current-day .cal-day-num .dow { color: white; }
.cal-day.active-stop .cal-day-bar { box-shadow: inset 0 0 0 1.5px var(--blush); }

/* â”€â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.totals { flex-shrink: 0; background: var(--snow); border-top: 1px solid var(--border); padding: 12px 16px; }
.totals-title { font-size: 0.5rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink3); margin-bottom: 8px; }
.totals-rows { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
.total-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.6rem; }
.total-row .l { color: var(--ink3); white-space: nowrap; }
.total-row .v { color: var(--ink2); font-weight: 500; white-space: nowrap; }
.total-row .bar-wrap { flex: 1; margin: 0 8px; height: 3px; border-radius: 10px; background: var(--border); overflow: hidden; }
.total-row .bar-fill { height: 100%; border-radius: 10px; }
.totals-sum { display: flex; justify-content: space-between; align-items: baseline; padding-top: 8px; border-top: 1px solid var(--border); }
.totals-sum .l { font-family: 'Shippori Mincho', serif; font-size: 0.78rem; font-weight: 600; color: var(--ink); }
.totals-sum .v { font-family: 'Shippori Mincho', serif; font-size: 1rem; font-weight: 700; color: var(--amber); }
.totals-sum .sub { font-size: 0.52rem; color: var(--ink3); text-align: right; }
/* Taux de change inline */
.fx-inline { font-size: 0.52rem; color: var(--ink3); margin-top: 4px; text-align: right; }
.fx-inline strong { color: var(--amber); }

/* â”€â”€â”€ LEAFLET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.leaflet-popup-content-wrapper {
  background: var(--snow); border: 1.5px solid var(--border);
  border-radius: var(--radius) !important; padding: 0 !important;
  box-shadow: 0 12px 40px rgba(0,0,0,0.12);
  font-family: 'Outfit', sans-serif; color: var(--ink); overflow: hidden;
  min-width: 260px;
}
.leaflet-popup-tip-container { display: none; }
.leaflet-popup-content { margin: 0; padding: 0; width: auto !important; }
.pop-photo-wrap { width: 100%; height: 130px; overflow: hidden; position: relative; }
.pop-photo-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
.pop-header { padding: 11px 15px 8px; border-bottom: 1px solid var(--border); }
.pop-city { font-family: 'Shippori Mincho', serif; font-size: 1.02rem; font-weight: 700; color: var(--ink); margin-bottom: 2px; }
.pop-dates { font-size: 0.58rem; color: var(--ink3); letter-spacing: 0.06em; }
.pop-body { padding: 9px 15px 13px; display: flex; flex-direction: column; gap: 6px; }
.pop-row { display: flex; gap: 8px; font-size: 0.62rem; align-items: flex-start; }
.pop-row .l { color: var(--ink3); min-width: 52px; flex-shrink: 0; font-size: 0.56rem; letter-spacing: 0.05em; }
.pop-row .r { color: var(--ink2); line-height: 1.5; }
.pop-row a { color: var(--sage); text-decoration: none; }
.pop-row a:hover { text-decoration: underline; }

/* Cluster styles */
.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
  background-color: rgba(196,126,126,0.2) !important;
}
.marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
  background-color: rgba(196,126,126,0.7) !important;
  color: white !important;
  font-family: 'Outfit', sans-serif !important;
  font-size: 0.7rem !important;
  font-weight: 600 !important;
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 800px) {
  :root { --panel: 100vw; }
  .btn-toggle { display: flex; }
  .hdr-meta, .hdr-sep, .hdr-progress, .hdr-fx, .hdr-countdown { display: none; }
  .panel { position: fixed; right: 0; top: var(--hdr); bottom: 0; transform: translateX(100%); box-shadow: -8px 0 32px rgba(0,0,0,0.15); z-index: 300; }
  .panel.open { transform: translateX(0); }
  #minimap { display: none; }
}
@media (min-width: 801px) and (max-width: 1100px) {
  :root { --panel: 300px; }
  .hdr-fx { display: none; }
}

/* Print */
@media print {
  header, #map, #minimap, .map-nav, .card-expand-btn, .view-tabs { display: none !important; }
  body, html { overflow: visible; height: auto; }
  .main { flex-direction: column; }
  .panel { width: 100%; border: none; transform: none !important; }
  .stop-card { break-inside: avoid; border: 1px solid #ccc; }
  .stop-card.expanded .card-body { max-height: none !important; }
  .card-body { max-height: none !important; overflow: visible !important; }
  .scroll { overflow: visible; max-height: none; }
  .view-pane { display: flex !important; }
  .view-pane:not(.active) { display: none !important; }
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-kanji">æ—¥æœ¬</span>
    <div class="logo-text">
      <span class="logo-main">Little Domo Very Arigato</span>
      <span class="logo-sub">Voyage au Japon Â· Nov â€” DÃ©c 2026</span>
    </div>
  </div>
  <div class="hdr-sep"></div>

  <!-- Compte Ã  rebours -->
  <div class="hdr-countdown" id="countdown">
    <span class="countdown-days" id="cntDays">â€”</span>
    <span class="countdown-label" id="cntLabel">jours</span>
  </div>

  <!-- Taux de change -->
  <div class="hdr-fx" id="fxWidget" title="1 EUR = __ JPY (estimÃ©)">
    ğŸ’´ 1â‚¬ = <span class="fx-rate" id="fxRate">163</span> Â¥
  </div>

  <!-- Weather -->
  <div class="hdr-weather" id="weatherToggle" onclick="toggleWeather(event)">
    ğŸ‚ <span class="weather-temp">10â€“18Â°C</span> â–¾
    <div class="weather-dropdown" id="weatherDropdown">
      <div class="weather-tabs" id="weatherTabs"></div>
      <div class="weather-panels" id="weatherPanels"></div>
    </div>
  </div>

  <div class="hdr-spacer"></div>

  <!-- Stop dots -->
  <div class="hdr-progress">
    <span class="progress-label">Ã‰tapes</span>
    <div class="progress-dots" id="dots"></div>
  </div>

  <!-- Dark mode -->
  <button class="hdr-btn" id="darkBtn" onclick="toggleDark()" title="Mode sombre">ğŸŒ™</button>

  <!-- Print/Share -->
  <button class="hdr-btn" onclick="printTrip()" title="Imprimer / Exporter PDF">ğŸ–¨ï¸</button>

  <button class="btn-toggle" onclick="togglePanel()" id="toggleBtn">â˜° Ã‰tapes</button>
</header>

<div class="main">
  <div id="map">
    <!-- Prev/Next nav -->
    <div class="map-nav">
      <button class="map-nav-btn" id="prevBtn" onclick="navStop(-1)">â† PrÃ©c.</button>
      <button class="map-nav-btn current-stop" id="currentStopBtn" style="display:none" onclick="resetMap()">ğŸ—¾ Vue gÃ©nÃ©rale</button>
      <button class="map-nav-btn" id="nextBtn" onclick="navStop(+1)">Suiv. â†’</button>
    </div>
  </div>

  <div class="panel" id="panel">
    <div class="panel-hdr">
      <!-- View switcher -->
      <div class="view-tabs">
        <div class="view-tab active" onclick="switchView('list', this)">ğŸ“‹ Liste</div>
        <div class="view-tab" onclick="switchView('calendar', this)">ğŸ“… Calendrier</div>
      </div>
      <div class="panel-meta">
        <div>
          <div class="panel-title">ItinÃ©raire</div>
          <div class="panel-sub">7 Ã©tapes Â· Cliquer pour dÃ©plier</div>
        </div>
        <div class="budget-pill">
          <span class="budget-amount">4 122 â‚¬</span>
          <span class="budget-label">total Â· 1 031 â‚¬/pers</span>
        </div>
      </div>
    </div>

    <div class="view-content">
      <!-- LIST VIEW -->
      <div class="view-pane active" id="pane-list">
        <div class="scroll" id="list"></div>
      </div>
      <!-- CALENDAR VIEW -->
      <div class="view-pane" id="pane-calendar">
        <div class="calendar-view" id="calendarView"></div>
      </div>
    </div>

    <div class="totals">
      <div class="totals-title">RÃ©partition du budget</div>
      <div class="totals-rows">
        <div class="total-row"><span class="l">ğŸ  Logements</span><div class="bar-wrap"><div class="bar-fill" style="width:51%;background:var(--sage)"></div></div><span class="v">2 086 â‚¬</span></div>
        <div class="total-row"><span class="l">ğŸš„ Transports</span><div class="bar-wrap"><div class="bar-fill" style="width:45%;background:var(--sky)"></div></div><span class="v">1 836 â‚¬</span></div>
        <div class="total-row"><span class="l">ğŸ¡ ActivitÃ©s</span><div class="bar-wrap"><div class="bar-fill" style="width:5%;background:var(--blush)"></div></div><span class="v">200 â‚¬</span></div>
      </div>
      <div class="totals-sum">
        <span class="l">Total estimÃ©</span>
        <div>
          <div class="v">4 122 â‚¬</div>
          <div class="sub">1 030,50 â‚¬ / personne</div>
        </div>
      </div>
      <div class="fx-inline">â‰ˆ <strong id="fxTotal">â€”</strong> Â¥ au total Â· <strong id="fxPers">â€”</strong> Â¥/pers</div>
    </div>
  </div>
</div>

<!-- Minimap container -->
<div id="minimap"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOPS = [
  { id:0, type:'transit', city:'Toulouse-Blagnac', dates:'Mer 18 nov 2026', lat:43.6291, lng:1.3638, note:'DÃ©part vers le Japon âœˆ', color:'#7a9bb5' },
  { id:1, type:'stop', city:'Tokyo', dates:'Jeu 19 â€“ Sam 21 nov', dateStart:'2026-11-19', dateEnd:'2026-11-22', lat:35.6762, lng:139.6503, color:'#c47e7e', logement:'Logement low cost', lienLog:'https://www.airbnb.fr/rooms/1551807196383187760?adults=4&check_in=2026-11-19&check_out=2026-11-22', altLog:'Ca a de la gueule', lienAlt:'https://www.airbnb.fr/rooms/1546827694877987513?adults=4&check_in=2026-11-19&check_out=2026-11-22', prix:363, prixP:90.75, activites:['Tsukiji','Shibuya crossing','Shinjuku'], note:'3 nuits Â· Premier contact avec Tokyo', reserved:false, weatherKey:'tokyo' },
  { id:2, type:'stop', city:'Kanazawa', dates:'Dim 22 nov', dateStart:'2026-11-22', dateEnd:'2026-11-23', lat:36.5613, lng:136.6562, color:'#9a8ab5', lienVille:'https://www.kanpai.fr/kanazawa', logement:'Moyen cost', lienLog:'https://www.airbnb.fr/rooms/28918502?adults=4&check_in=2026-11-22&check_out=2026-11-23', altLog:'Marrant', lienAlt:'https://www.airbnb.fr/rooms/711357847961458309?adults=4&check_in=2026-11-22&check_out=2026-11-23', prix:250, prixP:62.5, activites:['Jardins Kenroku-en','Quartier Higashi Chaya'], duree:'2h30 depuis Tokyo', trajet:90, note:'1 nuit Â· Ville des arts et du Noh', reserved:false, weatherKey:'kanazawa' },
  { id:3, type:'stop', city:'Takayama', dates:'Lun 23 â€“ Mar 24 nov', dateStart:'2026-11-23', dateEnd:'2026-11-25', lat:36.1461, lng:137.2523, color:'#b8924a', lienVille:'https://www.kanpai.fr/takayama', logement:"C'est joli", lienLog:'https://www.booking.com/hotel/jp/ryokufuen-kiyoharu.fr.html?checkin=2026-11-23&checkout=2026-11-25&group_adults=4', altLog:'Lave-linge + sÃ¨che-linge', lienAlt:'https://www.airbnb.fr/rooms/1498316738993785321?adults=4&check_in=2026-11-23&check_out=2026-11-25', prix:475, prixP:118.75, activites:['Shirakawa-go','Reco kinÃ©','Vieux quartier Sanmachi'], duree:'1h15 + 50min (via Shirakawa)', trajet:30, note:'2 nuits Â· Village de montagne', reserved:false, weatherKey:'takayama' },
  { id:4, type:'stop', city:'Kyoto', dates:'Mer 25 â€“ Ven 27 nov', dateStart:'2026-11-25', dateEnd:'2026-11-28', lat:35.0116, lng:135.7681, color:'#7a9e8e', logement:'Lave-linge', lienLog:'https://www.airbnb.fr/rooms/14239019?adults=4&check_in=2026-11-25&check_out=2026-11-28', altLog:'SÃ¨che-linge', lienAlt:'https://www.airbnb.fr/rooms/39423656?adults=4&check_in=2026-11-25&check_out=2026-11-28', prix:250, prixP:62.5, activites:['Excursion Nara (A/R 1h30)','Fushimi Inari','Arashiyama'], duree:'Train 3h30', trajet:65, note:'3 nuits Â· Capitale impÃ©riale', reserved:false, weatherKey:'kyoto' },
  { id:5, type:'stop', city:'Hiroshima', dates:'Sam 28 nov', dateStart:'2026-11-28', dateEnd:'2026-11-29', lat:34.3853, lng:132.4553, color:'#7a9bb5', logement:'Prix sympa', lienLog:'https://www.airbnb.fr/rooms/1308373761672649274?adults=4&check_in=2026-11-28&check_out=2026-11-29', altLog:'Trad house', lienAlt:'https://www.airbnb.fr/rooms/990378354416365514?adults=4&check_in=2026-11-28&check_out=2026-11-29', prix:137, prixP:34.25, activites:['MÃ©morial de la Paix','Ãle de Miyajima','Torii flottant'], duree:'1h45 depuis Kyoto', trajet:70, note:'1 nuit Â· Histoire & mÃ©moire', reserved:false, weatherKey:'hiroshima' },
  { id:6, type:'stop', city:'Osaka', dates:'Dim 29 nov â€“ Mar 1 dÃ©c', dateStart:'2026-11-29', dateEnd:'2026-12-02', lat:34.6937, lng:135.5023, color:'#c47e7e', logement:'Very economic', lienLog:'https://www.airbnb.fr/rooms/1547744592796575135?adults=4&check_in=2026-11-29&check_out=2026-12-02', altLog:'Fancy time (trÃ¨s cool)', lienAlt:'https://www.airbnb.fr/rooms/1547112363118924811?adults=4&check_in=2026-11-29&check_out=2026-12-02', prix:100, prixP:25, activites:['Universal Studio ğŸ¢','Dotonbori','Takoyaki',"ChÃ¢teau d'Osaka"], duree:'1h30 depuis Hiroshima', trajet:65, note:'3 nuits Â· Gastronomie & fun', reserved:false, weatherKey:'osaka' },
  { id:7, type:'stop', city:'Magome', dates:'Mer 2 dÃ©c', dateStart:'2026-12-02', dateEnd:'2026-12-03', lat:35.5254, lng:137.5512, color:'#9a8ab5', lienVille:'https://www.voyagejapon.com/guide-japon/destination/magome', logement:'Ryokan O', lienLog:'https://www.airbnb.fr/rooms/45091164?adults=4&check_in=2026-12-02&check_out=2026-12-03', prix:140, prixP:35, activites:['Route Nakasendo','Shibu Onsen ?','Village Edo'], duree:'3h30â€“4h depuis Osaka', trajet:50, note:'1 nuit Â· Village Edo authentique', reserved:false, weatherKey:'magome' },
  { id:8, type:'stop', city:'Tokyo', dates:'Jeu 3 â€“ Ven 4 dÃ©c', dateStart:'2026-12-03', dateEnd:'2026-12-05', lat:35.6894, lng:139.6917, color:'#c47e7e', logement:'Correct', lienLog:'https://www.airbnb.fr/rooms/1504875726419858451?adults=4&check_in=2026-12-03&check_out=2026-12-05', prix:371, prixP:92.75, activites:['Shopping Shibuya','Akihabara','Derniers souvenirs','Harajuku'], duree:'3h depuis Magome', trajet:80, note:'2 nuits Â· Fin du voyage', reserved:false, weatherKey:'tokyo' },
  { id:9, type:'transit', city:'AÃ©roport de Tokyo', dates:'Sam 5 dÃ©c 2026', dateStart:'2026-12-05', lat:35.5494, lng:139.7798, color:'#7a9bb5', note:'Retour vers la France ğŸ ' }
];

const WEATHER = {
  tokyo: {
    city: 'Tokyo', period: '19â€“21 nov & 3â€“4 dÃ©c Â· moy. JMA 1991â€“2020',
    summary: `Novembre est le mois le plus sec et ensoleillÃ© de l'automne Ã  Tokyo. Les tempÃ©ratures descendent progressivement : ~16Â°C mi-novembre, ~12Â°C dÃ©but dÃ©cembre. Feuillages (momiji) Ã  leur pic autour du 25â€“30 nov. TrÃ¨s peu de pluie.`,
    days: [{ date:'19 nov', icon:'â˜€ï¸', max:17, min:10, rain:'8%', sun:'6h' },{ date:'20 nov', icon:'â˜€ï¸', max:17, min:10, rain:'8%', sun:'6h' },{ date:'21 nov', icon:'ğŸŒ¤', max:16, min:9, rain:'10%', sun:'5h' },{ date:'3 dÃ©c', icon:'ğŸŒ¤', max:13, min:6, rain:'12%', sun:'5h' },{ date:'4 dÃ©c', icon:'ğŸŒ¤', max:13, min:6, rain:'12%', sun:'5h' }]
  },
  kanazawa: {
    city: 'Kanazawa', period: '22 nov Â· moy. JMA 1991â€“2020',
    summary: `Kanazawa reÃ§oit les vents humides de la mer du Japon en novembre. Ciel souvent couvert, averses possibles. Les jardins Kenroku-en sont splendides sous la brume automnale. PrÃ©voir impermÃ©able.`,
    days: [{ date:'22 nov', icon:'ğŸŒ¥', max:14, min:7, rain:'40%', sun:'2h' }]
  },
  takayama: {
    city: 'Takayama', period: '23â€“24 nov Â· moy. JMA 1991â€“2020',
    summary: `En altitude (730m), Takayama est nettement plus froid. Fin novembre : premiÃ¨res gelÃ©es nocturnes quasi certaines. Neige possible mais rare. Les matins sont glacials et magnifiques. Superposez les couches !`,
    days: [{ date:'23 nov', icon:'ğŸŒ¤', max:10, min:1, rain:'15%', sun:'4h' },{ date:'24 nov', icon:'ğŸŒ¥', max:9, min:0, rain:'20%', sun:'3h' }]
  },
  kyoto: {
    city: 'Kyoto', period: '25â€“27 nov Â· moy. JMA 1991â€“2020',
    summary: `La fin novembre est le moment idÃ©al Ã  Kyoto : les Ã©rables (momiji) sont Ã  leur apogÃ©e de couleur rouge-orangÃ©. TempÃ©ratures agrÃ©ables en journÃ©e, fraÃ®ches le soir. Week-ends trÃ¨s frÃ©quentÃ©s.`,
    days: [{ date:'25 nov', icon:'â˜€ï¸', max:16, min:8, rain:'7%', sun:'5h' },{ date:'26 nov', icon:'â˜€ï¸', max:16, min:8, rain:'7%', sun:'5h' },{ date:'27 nov', icon:'ğŸŒ¤', max:15, min:7, rain:'10%', sun:'4h' }]
  },
  hiroshima: {
    city: 'Hiroshima', period: '28 nov Â· moy. JMA 1991â€“2020',
    summary: `Hiroshima bÃ©nÃ©ficie d'un microclimat doux grÃ¢ce Ã  sa baie. Fin novembre : temps souvent clair et agrÃ©able, lÃ©gÃ¨rement plus chaud que Kyoto. Miyajima et son torii sont magnifiques sous le soleil d'automne.`,
    days: [{ date:'28 nov', icon:'â˜€ï¸', max:17, min:9, rain:'6%', sun:'5h' }]
  },
  osaka: {
    city: 'Osaka', period: '29 nov â€“ 1 dÃ©c Â· moy. JMA 1991â€“2020',
    summary: `Osaka fin novembre : doux et peu pluvieux. DÃ©but dÃ©cembre le froid s'installe plus nettement. Les soirÃ©es Ã  Dotonbori nÃ©cessitent un bon manteau. JournÃ©es ensoleillÃ©es idÃ©ales pour explorer.`,
    days: [{ date:'29 nov', icon:'â˜€ï¸', max:17, min:9, rain:'6%', sun:'5h' },{ date:'30 nov', icon:'ğŸŒ¤', max:16, min:8, rain:'8%', sun:'5h' },{ date:'1 dÃ©c', icon:'ğŸŒ¤', max:15, min:7, rain:'10%', sun:'4h' }]
  },
  magome: {
    city: 'Magome', period: '2 dÃ©c Â· moy. JMA 1991â€“2020',
    summary: `Village de montagne Ã  ~600m. DÃ©but dÃ©cembre : froid vif, possibilitÃ© de givre ou petite neige. L'ambiance du village Edo sous le froid est particuliÃ¨rement authentique. Le ryokan et son bain chaud seront bienvenus.`,
    days: [{ date:'2 dÃ©c', icon:'ğŸŒ¥', max:9, min:1, rain:'18%', sun:'3h' }]
  }
};

const CITY_PHOTOS = {
  1: { url:'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&h=130&fit=crop&q=80', color:'#1a1f35' },
  2: { url:'https://images.unsplash.com/photo-1528360983277-13d401cdc186?w=400&h=130&fit=crop&q=80', color:'#2d4a3e' },
  3: { url:'https://images.unsplash.com/photo-1598935898639-81586f7d2129?w=400&h=130&fit=crop&q=80', color:'#3a2818' },
  4: { url:'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400&h=130&fit=crop&q=80', color:'#1a3028' },
  5: { url:'https://images.unsplash.com/photo-1524413840807-0c3cb6fa808d?w=400&h=130&fit=crop&q=80', color:'#2a4a6a' },
  6: { url:'https://images.unsplash.com/photo-1589452271712-64b8a66c7b71?w=400&h=130&fit=crop&q=80', color:'#2a4a2a' },
  7: { url:'https://images.unsplash.com/photo-1480796927426-f609979314bd?w=400&h=130&fit=crop&q=80', color:'#2a3a28' },
  8: { url:'https://images.unsplash.com/photo-1503899036084-c55cdd92da26?w=400&h=130&fit=crop&q=80', color:'#0d0f1a' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FX RATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FX_EUR_JPY = 163; // taux indicatif Nov 2026 estimÃ©
document.getElementById('fxRate').textContent = FX_EUR_JPY;
document.getElementById('fxTotal').textContent = (4122 * FX_EUR_JPY).toLocaleString('fr-FR') ;
document.getElementById('fxPers').textContent = (1030.5 * FX_EUR_JPY).toLocaleString('fr-FR');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN + "ON EST AU JAPON" MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEPART = new Date('2026-11-18T00:00:00');
const RETOUR = new Date('2026-12-05T23:59:59');

function updateCountdown() {
  const now = new Date();
  const cntEl = document.getElementById('countdown');
  const daysEl = document.getElementById('cntDays');
  const labelEl = document.getElementById('cntLabel');

  if (now < DEPART) {
    const diff = Math.ceil((DEPART - now) / 86400000);
    daysEl.textContent = diff;
    labelEl.textContent = diff === 1 ? 'jour avant âœˆ' : 'jours avant âœˆ';
    cntEl.classList.remove('live');
  } else if (now <= RETOUR) {
    const day = Math.floor((now - DEPART) / 86400000) + 1;
    daysEl.textContent = `J+${day}`;
    labelEl.textContent = 'On est au Japon ! ğŸŒ';
    cntEl.classList.add('live');
    // Highlight current stop
    highlightCurrentStop();
  } else {
    daysEl.textContent = 'ğŸŒ';
    labelEl.textContent = 'Voyage terminÃ©';
    cntEl.classList.remove('live');
  }
}

function getCurrentStop() {
  const today = new Date();
  today.setHours(0,0,0,0);
  return STOPS.find(s => s.type === 'stop' && s.dateStart && s.dateEnd && today >= new Date(s.dateStart) && today < new Date(s.dateEnd));
}

function highlightCurrentStop() {
  const cur = getCurrentStop();
  if (!cur) return;
  document.querySelectorAll('.stop-card').forEach(c => c.classList.remove('current-stay'));
  const card = document.getElementById(`c${cur.id}`);
  if (card) card.classList.add('current-stay');
}

updateCountdown();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DARK MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDark() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('darkBtn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
  if (minimap) { minimap.invalidateSize(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printTrip() {
  // Expand all cards before printing
  document.querySelectorAll('.stop-card').forEach(c => {
    c.classList.add('expanded');
    const body = c.querySelector('.card-body');
    if (body) body.style.maxHeight = '9000px';
  });
  // Switch to list view
  switchView('list', document.querySelector('.view-tab'));
  setTimeout(() => window.print(), 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER WIDGET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const jpStops = STOPS.filter(s => s.type === 'stop');
const weatherKeys = [...new Set(jpStops.map(s => s.weatherKey).filter(Boolean))];
const tabsEl = document.getElementById('weatherTabs');
const panelsEl = document.getElementById('weatherPanels');

weatherKeys.forEach((key, idx) => {
  const w = WEATHER[key];
  if (!w) return;
  const tab = document.createElement('div');
  tab.className = 'weather-tab' + (idx === 0 ? ' active' : '');
  tab.textContent = w.city;
  tab.onclick = e => {
    e.stopPropagation();
    document.querySelectorAll('.weather-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.weather-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('wp-' + key).classList.add('active');
  };
  tabsEl.appendChild(tab);

  const panel = document.createElement('div');
  panel.className = 'weather-panel' + (idx === 0 ? ' active' : '');
  panel.id = 'wp-' + key;
  const days = w.days.map(d => `
    <div class="wf-day">
      <div class="wf-day-name">${d.date}</div>
      <div class="wf-icon">${d.icon}</div>
      <div class="wf-max">${d.max}Â°</div>
      <div class="wf-min">${d.min}Â°</div>
      <div class="wf-rain">â˜” ${d.rain}</div>
      ${d.sun ? `<div class="wf-rain" style="color:var(--amber)">â˜€ï¸${d.sun}</div>` : ''}
    </div>`).join('');
  panel.innerHTML = `
    <div class="weather-city-name">${w.city}</div>
    <div class="weather-city-period">${w.period}</div>
    <div class="weather-forecast">${days}</div>
    <div class="weather-summary">${w.summary}</div>
    <div class="weather-source">â˜… DonnÃ©es historiques Â· JMA 1991â€“2020</div>`;
  panelsEl.appendChild(panel);
});

function toggleWeather(e) {
  e.stopPropagation();
  document.getElementById('weatherDropdown').classList.toggle('open');
}
document.addEventListener('click', () => document.getElementById('weatherDropdown').classList.remove('open'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', { zoomControl: false });
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: 'Â©OpenStreetMap Â©CARTO', maxZoom: 19
}).addTo(map);

const initialBounds = L.latLngBounds(jpStops.map(s => [s.lat, s.lng]));
map.fitBounds(initialBounds, { padding: [60, 60] });

function resetMap() {
  map.closePopup();
  map.flyToBounds(initialBounds, { padding: [60, 60], duration: 1.2, easeLinearity: 0.3 });
  document.getElementById('currentStopBtn').style.display = 'none';
}

// â”€â”€ MINIMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const minimap = L.map('minimap', { zoomControl: false, dragging: false, touchZoom: false, doubleClickZoom: false, scrollWheelZoom: false, boxZoom: false, keyboard: false, attributionControl: false });
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 10 }).addTo(minimap);
minimap.setView([36.5, 137.5], 5);
// Highlight Japan bounds on minimap
const minimapRect = L.rectangle(initialBounds, { color: '#c47e7e', weight: 2, fillOpacity: 0.1, dashArray: '4 3' }).addTo(minimap);
// Dot for current view
let minimapDot = null;

map.on('moveend', () => {
  const center = map.getCenter();
  if (minimapDot) minimapDot.remove();
  minimapDot = L.circleMarker([center.lat, center.lng], { radius: 5, color: '#c47e7e', fillColor: '#c47e7e', fillOpacity: 0.8, weight: 2 }).addTo(minimap);
});

// â”€â”€ ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeIcon(label, color, active, isTransit) {
  const size = isTransit ? 22 : 32;
  const bg = active ? color : '#ffffff';
  const textColor = active ? '#ffffff' : color;
  const shadow = active ? `0 4px 16px ${color}55` : '0 2px 8px rgba(0,0,0,0.15)';
  return L.divIcon({
    className: '',
    html: `<div style="background:${bg};color:${textColor};width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;font-family:'Outfit',sans-serif;font-size:${isTransit ? '0.7' : '0.68'}rem;font-weight:600;border:2px solid ${color};border-radius:50%;box-shadow:${shadow};transition:all 0.25s">${label}</div>`,
    iconSize: [size, size], iconAnchor: [size/2, size/2], popupAnchor: [0, -size/2 - 4]
  });
}

// â”€â”€ POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePopup(s) {
  const p = CITY_PHOTOS[s.id];
  const photoHtml = p
    ? `<div class="pop-photo-wrap" style="background:${p.color}"><img src="${p.url}" alt="${s.city}" loading="lazy" onerror="this.style.display='none'"/></div>`
    : '';
  const logHTML = s.logement ? `<div class="pop-row"><span class="l">Logement</span><span class="r">${s.lienLog ? `<a href="${s.lienLog}" target="_blank">${s.logement}</a>` : s.logement}${s.altLog ? ` Â· <a href="${s.lienAlt||'#'}" target="_blank">${s.altLog}</a>` : ''}</span></div>` : '';
  const prixHTML = s.prix ? `<div class="pop-row"><span class="l">Prix nuit</span><span class="r">${s.prix} â‚¬ <span style="opacity:0.5">(${s.prixP} â‚¬/pers)</span></span></div>` : '';
  const actHTML = s.activites?.length ? `<div class="pop-row"><span class="l">ActivitÃ©s</span><span class="r">${s.activites.join(' Â· ')}</span></div>` : '';
  const noteHTML = s.note ? `<div class="pop-row"><span class="l">Note</span><span class="r" style="font-style:italic;opacity:0.7">${s.note}</span></div>` : '';
  return `${photoHtml}
    <div class="pop-header">
      <div style="width:100%;height:3px;border-radius:10px;background:${s.color||'#ccc'};margin-bottom:8px"></div>
      <div class="pop-city">${s.city}</div>
      <div class="pop-dates">${s.dates || ''}</div>
    </div>
    <div class="pop-body">${logHTML}${prixHTML}${actHTML}${noteHTML}</div>`;
}

// â”€â”€ CLUSTER + MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 40,
  disableClusteringAtZoom: 10,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
  iconCreateFunction: cluster => L.divIcon({
    html: `<div style="background:rgba(196,126,126,0.85);color:white;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Outfit',sans-serif;font-size:0.72rem;font-weight:700;border:2px solid white;box-shadow:0 2px 10px rgba(196,126,126,0.4)">${cluster.getChildCount()}</div>`,
    iconSize: [34, 34], iconAnchor: [17, 17]
  })
});

const lMarkers = [];
let num = 0;
let activeIdx = null;
let expandedIdx = null;

STOPS.forEach((s, i) => {
  const isT = s.type === 'transit';
  if (!isT) num++;
  const lbl = isT ? 'âœˆ' : String(num);
  const m = L.marker([s.lat, s.lng], { icon: makeIcon(lbl, s.color || '#999', false, isT) })
    .bindPopup(makePopup(s), { maxWidth: 300, className: '' });
  m.on('click', () => activateStop(i));

  if (!isT) {
    clusterGroup.addLayer(m);
  } else {
    m.addTo(map);
  }
  lMarkers.push({ m, lbl, isT });
});
clusterGroup.addTo(map);

// Route
L.polyline(STOPS.filter(s => s.lat).map(s => [s.lat, s.lng]), {
  color: '#b8924a', weight: 1.5, opacity: 0.3, dashArray: '5 9'
}).addTo(map);

// â”€â”€ DOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dotsEl = document.getElementById('dots');
const stopIndices = STOPS.map((s,i) => s.type === 'stop' ? i : null).filter(x => x !== null);
stopIndices.forEach(si => {
  const d = document.createElement('button');
  d.className = 'pdot';
  d.title = STOPS[si].city;
  d.style.background = STOPS[si].color;
  d.style.opacity = '0.35';
  d.onclick = e => { e.stopPropagation(); activateStop(si); };
  d.id = `dot-${si}`;
  dotsEl.appendChild(d);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR â€” LIST VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const listEl = document.getElementById('list');
let sideN = 0;

STOPS.forEach((s, i) => {
  if (s.type === 'transit') {
    const sep = document.createElement('div');
    sep.className = 'sep';
    sep.innerHTML = `<div class="sep-line"></div><div class="sep-chip">âœˆ ${s.city}</div><div class="sep-line"></div>`;
    listEl.appendChild(sep);
    return;
  }

  sideN++;
  const card = document.createElement('div');
  card.className = 'stop-card';
  card.id = `c${i}`;
  card.style.animationDelay = `${sideN * 0.06}s`;

  const qChips = [];
  if (s.prix) qChips.push(`<span class="quick-chip" style="background:${s.color}18;color:${s.color};border:1px solid ${s.color}30">ğŸ  ${s.prixP}â‚¬/pers</span>`);
  if (s.trajet) qChips.push(`<span class="quick-chip" style="background:var(--sky-l);color:var(--sky);border:1px solid rgba(122,155,181,0.2)">ğŸš„ ${s.duree?.split(' ')[0]}</span>`);
  if (s.activites?.length) qChips.push(`<span class="quick-chip" style="background:var(--sage-l);color:var(--sage);border:1px solid rgba(122,158,142,0.2)">ğŸ“ ${s.activites.length} activitÃ©${s.activites.length > 1 ? 's' : ''}</span>`);
  if (s.weatherKey && WEATHER[s.weatherKey]) {
    const w = WEATHER[s.weatherKey];
    const avg = Math.round(w.days.reduce((a, d) => a + (d.max + d.min) / 2, 0) / w.days.length);
    qChips.push(`<span class="quick-chip" style="background:var(--amber-l);color:var(--amber);border:1px solid rgba(184,146,74,0.2)">ğŸŒ¡ ~${avg}Â°C</span>`);
  }

  const mainOpt = s.logement ? `<a class="lodge-option main-opt" href="${s.lienLog||'#'}" target="_blank" onclick="event.stopPropagation()"><span class="lodge-badge badge-main">Choix 1</span><span class="lodge-name">${s.logement}</span>${s.prix ? `<span class="lodge-price">${s.prix}â‚¬</span>` : ''}<span class="lodge-arrow">â†’</span></a>` : '';
  const altOpt = s.altLog ? `<a class="lodge-option alt-opt" href="${s.lienAlt||'#'}" target="_blank" onclick="event.stopPropagation()"><span class="lodge-badge badge-alt">Alt.</span><span class="lodge-name">${s.altLog}</span><span class="lodge-arrow">â†’</span></a>` : '';

  const actPills = s.activites?.map(a => `<span class="activity-pill">${a}</span>`).join('') || '';
  const trajetRow = s.duree ? `<div class="detail-row"><div class="detail-icon" style="background:var(--sky-l)">ğŸš„</div><div class="detail-content"><div class="detail-label">Trajet</div><div class="detail-value">${s.duree}${s.trajet ? ` Â· <strong>${s.trajet}â‚¬/pers</strong>` : ''}</div></div></div>` : '';
  const noteRow = s.note ? `<div class="detail-row"><div class="detail-icon" style="background:var(--amber-l)">âœ¦</div><div class="detail-content"><div class="detail-label">Note</div><div class="detail-value" style="font-style:italic;opacity:0.8">${s.note}</div></div></div>` : '';

  let weatherMini = '';
  if (s.weatherKey && WEATHER[s.weatherKey]) {
    const w = WEATHER[s.weatherKey];
    const dayPills = w.days.map(d => `<div style="text-align:center;padding:4px 6px;background:var(--surface2);border-radius:8px;font-size:0.55rem;flex-shrink:0"><div style="color:var(--ink3);font-size:0.44rem;white-space:nowrap">${d.date}</div><div style="font-size:0.95rem;margin:2px 0">${d.icon}</div><div style="font-weight:600;color:var(--ink)">${d.max}Â°</div><div style="color:var(--ink3)">${d.min}Â°</div><div style="font-size:0.42rem;color:var(--sky)">â˜”${d.rain}</div></div>`).join('');
    weatherMini = `<div><div class="lodge-title">MÃ©tÃ©o (historique JMA)</div><div style="display:flex;gap:4px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none">${dayPills}</div><div style="font-size:0.54rem;color:var(--ink3);margin-top:6px;line-height:1.5">${w.summary}</div></div>`;
  }

  const guideRow = s.lienVille ? `<a class="guide-link" href="${s.lienVille}" target="_blank" onclick="event.stopPropagation()">ğŸ—º Guide de ${s.city}</a>` : '';

  card.innerHTML = `
    <div class="card-strip" style="background:${s.color}"></div>
    <div class="card-head-row" onclick="toggleExpand(${i}, event)">
      <div class="card-num-city">
        <div class="card-num" style="color:${s.color}">Ã‰tape ${String(sideN).padStart(2,'0')}</div>
        <div class="card-city">${s.city}</div>
      </div>
      <div class="card-right">
        <div class="card-dates">${s.dates}</div>
        <div class="card-expand-btn"><span class="arrow">â–¾</span></div>
      </div>
    </div>
    ${qChips.length ? `<div class="card-quick">${qChips.join('')}</div>` : ''}
    <div class="card-body">
      <div class="card-body-inner">
        ${(mainOpt || altOpt) ? `<div><div class="lodge-title">HÃ©bergement</div><div class="lodge-options">${mainOpt}${altOpt}</div></div>` : ''}
        ${actPills ? `<div><div class="lodge-title">ActivitÃ©s</div><div class="activity-pills">${actPills}</div></div>` : ''}
        ${weatherMini}
        ${trajetRow}${noteRow}${guideRow}
      </div>
    </div>`;

  card.addEventListener('click', e => {
    if (!e.target.closest('.lodge-option') && !e.target.closest('.guide-link') && !e.target.closest('.card-head-row')) {
      activateStop(i);
    }
  });
  listEl.appendChild(card);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCalendar() {
  const calEl = document.getElementById('calendarView');
  const DAYS_FR = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];

  // Build a map: date string -> stop
  const dateMap = {};
  STOPS.filter(s => s.dateStart).forEach(s => {
    if (s.type === 'transit') {
      dateMap[s.dateStart] = { ...s, calType: 'transit' };
    } else if (s.dateStart && s.dateEnd) {
      let d = new Date(s.dateStart);
      const end = new Date(s.dateEnd);
      while (d < end) {
        dateMap[d.toISOString().slice(0,10)] = { ...s, calType: 'stop' };
        d.setDate(d.getDate() + 1);
      }
    }
  });

  // Build from Nov 18 to Dec 5
  const start = new Date('2026-11-18');
  const end   = new Date('2026-12-05');
  const today = new Date(); today.setHours(0,0,0,0);

  let currentMonth = '';
  let monthEl = null, daysEl = null;

  let d = new Date(start);
  while (d <= end) {
    const ds = d.toISOString().slice(0,10);
    const month = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

    if (month !== currentMonth) {
      currentMonth = month;
      monthEl = document.createElement('div');
      monthEl.className = 'cal-month';
      monthEl.innerHTML = `<div class="cal-month-title">${month.charAt(0).toUpperCase() + month.slice(1)}</div>`;
      daysEl = document.createElement('div');
      daysEl.className = 'cal-days';
      monthEl.appendChild(daysEl);
      calEl.appendChild(monthEl);
    }

    const info = dateMap[ds];
    const isToday = d.getTime() === today.getTime();
    const dow = DAYS_FR[d.getDay()];
    const dayNum = d.getDate();

    const dayEl = document.createElement('div');
    dayEl.className = 'cal-day' + (info ? (info.calType === 'transit' ? ' transit' : ' has-stop') : ' travel') + (isToday ? ' current-day' : '');

    let barContent = '';
    if (info) {
      const color = info.color || '#aaa';
      if (info.calType === 'transit') {
        barContent = `<div class="cal-stop-city" style="font-size:0.75rem;color:var(--sky)">âœˆ ${info.city}</div><div class="cal-stop-meta">${info.note || ''}</div>`;
        dayEl.style.setProperty('--stop-color', 'var(--sky)');
      } else {
        const stopN = stopIndices.indexOf(STOPS.indexOf(STOPS.find(s => s.id === info.id))) + 1;
        barContent = `<div class="cal-stop-city" style="color:${color}">${info.city}</div><div class="cal-stop-meta">${info.prix ? `ğŸ  ${info.prixP}â‚¬/pers` : ''}</div><div class="cal-stop-badge" style="background:${color}18;color:${color};border:1px solid ${color}30">Ã‰tape ${stopN > 0 ? stopN : ''}</div>`;
        dayEl.style.borderLeft = `3px solid ${color}`;
        dayEl.style.setProperty('--stop-color', color);
        // click
        const stopIdx = STOPS.findIndex(s => s.id === info.id);
        if (stopIdx >= 0) {
          dayEl.addEventListener('click', () => {
            switchView('list', document.querySelector('.view-tab'));
            setTimeout(() => { toggleExpand(stopIdx, null); }, 100);
          });
          dayEl.style.cursor = 'pointer';
        }
      }
    } else {
      barContent = `<div style="font-size:0.58rem;color:var(--ink3);font-style:italic">En transit</div>`;
    }

    dayEl.innerHTML = `
      <div class="cal-day-num"><span class="num">${dayNum}</span><span class="dow">${dow}</span></div>
      <div class="cal-day-bar">${barContent}</div>`;
    daysEl.appendChild(dayEl);
    d.setDate(d.getDate() + 1);
  }
}
buildCalendar();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(name, tabEl) {
  document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view-pane').forEach(p => p.classList.remove('active'));
  if (tabEl) tabEl.classList.add('active');
  else document.querySelectorAll('.view-tab')[name === 'list' ? 0 : 1].classList.add('active');
  document.getElementById(`pane-${name}`).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE EXPAND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleExpand(idx, e) {
  if (e) e.stopPropagation();
  const card = document.getElementById(`c${idx}`);
  if (!card) return;

  if (expandedIdx !== null && expandedIdx !== idx) {
    document.getElementById(`c${expandedIdx}`)?.classList.remove('expanded');
  }

  const wasExpanded = card.classList.contains('expanded');
  card.classList.toggle('expanded', !wasExpanded);
  expandedIdx = wasExpanded ? null : idx;

  if (!wasExpanded) {
    activateStop(idx);
    setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'start' }), 60);
  } else {
    // Close â†’ reset map
    card.classList.remove('active');
    const lm = lMarkers[idx];
    if (lm) lm.m.setIcon(makeIcon(lm.lbl, STOPS[idx].color || '#999', false, lm.isT));
    const dot = document.getElementById(`dot-${idx}`);
    if (dot) { dot.classList.remove('active'); dot.style.opacity = '0.4'; dot.style.transform = 'scale(1)'; }
    activeIdx = null;
    resetMap();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVATE STOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activateStop(idx) {
  if (activeIdx !== null && activeIdx !== idx) {
    document.getElementById(`c${activeIdx}`)?.classList.remove('active');
    const prev = lMarkers[activeIdx];
    if (prev) prev.m.setIcon(makeIcon(prev.lbl, STOPS[activeIdx].color || '#999', false, prev.isT));
    const prevDot = document.getElementById(`dot-${activeIdx}`);
    if (prevDot) { prevDot.classList.remove('active'); prevDot.style.opacity = '0.4'; prevDot.style.transform = 'scale(1)'; }
  }

  activeIdx = idx;
  const s = STOPS[idx];

  const card = document.getElementById(`c${idx}`);
  if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }

  const lm = lMarkers[idx];
  if (lm) {
    lm.m.setIcon(makeIcon(lm.lbl, s.color || '#999', true, lm.isT));
    map.flyTo([s.lat, s.lng], s.type === 'transit' ? 8 : 11, { duration: 1.4, easeLinearity: 0.25 });
    setTimeout(() => lm.m.openPopup(), 900);
  }

  stopIndices.forEach(si => {
    const d = document.getElementById(`dot-${si}`);
    if (!d) return;
    d.classList.toggle('active', si === idx);
    d.style.opacity = si === idx ? '1' : '0.4';
    d.style.transform = si === idx ? 'scale(1.4)' : 'scale(1)';
  });

  // Show "vue gÃ©nÃ©rale" button
  document.getElementById('currentStopBtn').style.display = 'flex';
  document.getElementById('currentStopBtn').textContent = `ğŸ—¾ Vue gÃ©nÃ©rale`;

  // Update nav buttons
  updateNavBtns(idx);

  if (window.innerWidth <= 800) {
    setTimeout(() => {
      document.getElementById('panel').classList.remove('open');
      document.getElementById('toggleBtn').textContent = 'â˜° Ã‰tapes';
    }, 300);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREV / NEXT NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateNavBtns(idx) {
  const pos = stopIndices.indexOf(idx);
  document.getElementById('prevBtn').disabled = pos <= 0;
  document.getElementById('nextBtn').disabled = pos >= stopIndices.length - 1;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if (pos > 0) prevBtn.textContent = `â† ${STOPS[stopIndices[pos-1]].city}`;
  else prevBtn.textContent = 'â† PrÃ©c.';
  if (pos < stopIndices.length - 1) nextBtn.textContent = `${STOPS[stopIndices[pos+1]].city} â†’`;
  else nextBtn.textContent = 'Suiv. â†’';
}

function navStop(dir) {
  if (activeIdx === null) {
    activateStop(stopIndices[dir > 0 ? 0 : stopIndices.length - 1]);
    return;
  }
  const pos = stopIndices.indexOf(activeIdx);
  const newPos = pos + dir;
  if (newPos >= 0 && newPos < stopIndices.length) {
    const newIdx = stopIndices[newPos];
    // Expand new card
    if (expandedIdx !== null) document.getElementById(`c${expandedIdx}`)?.classList.remove('expanded');
    expandedIdx = null;
    toggleExpand(newIdx, null);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE MOBILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let touchStartX = 0;
document.getElementById('map').addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
document.getElementById('map').addEventListener('touchend', e => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  if (Math.abs(dx) > 60) navStop(dx < 0 ? 1 : -1);
}, { passive: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePanel() {
  const p = document.getElementById('panel');
  const open = p.classList.toggle('open');
  document.getElementById('toggleBtn').textContent = open ? 'âœ• Fermer' : 'â˜° Ã‰tapes';
}
</script>
</body>
</html>
