<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Little Domo Very Arigato â€” Japon 2026</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@1,400;1,500&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:        #f0ede8;
  --surface:   #faf8f5;
  --surface2:  #f4f1ec;
  --border:    #e2ddd6;
  --border2:   #cdc7be;
  --sage:      #7a9e8e;
  --sage-l:    #e8f0ec;
  --blush:     #c47e7e;
  --blush-l:   #f5e8e8;
  --sky:       #7a9bb5;
  --sky-l:     #e8eff5;
  --amber:     #b8924a;
  --amber-l:   #f5eedf;
  --lavender:  #9a8ab5;
  --lavender-l:#f0edf7;
  --ink:       #2a2520;
  --ink2:      #5a524a;
  --ink3:      #8a8078;
  --snow:      #fdfcfa;
  --panel:     360px;
  --hdr:       60px;
  --radius:    14px;
  --radius-sm: 8px;
}

html, body { height: 100%; overflow: hidden; }
body { font-family: 'Outfit', sans-serif; color: var(--ink); display: flex; flex-direction: column; background: var(--bg); }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  height: var(--hdr); flex-shrink: 0;
  display: flex; align-items: center; padding: 0 20px; gap: 14px;
  background: var(--snow); border-bottom: 1px solid var(--border); z-index: 400;
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-kanji { font-family: 'Shippori Mincho', serif; font-size: 1.5rem; color: var(--blush); line-height: 1; }
.logo-text { display: flex; flex-direction: column; gap: 1px; }
.logo-main { font-family: 'Shippori Mincho', serif; font-size: 0.92rem; font-weight: 600; color: var(--ink); letter-spacing: 0.04em; }
.logo-sub { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.75rem; color: var(--ink3); letter-spacing: 0.06em; }
.hdr-sep { width: 1px; height: 26px; background: var(--border); flex-shrink: 0; }
.hdr-meta { font-size: 0.62rem; color: var(--ink3); letter-spacing: 0.06em; line-height: 1.7; }
.hdr-meta strong { color: var(--ink2); font-weight: 500; }
.hdr-spacer { flex: 1; }

/* Weather widget â€“ interactive */
.hdr-weather {
  display: flex; align-items: center; gap: 6px;
  background: var(--sage-l); border: 1px solid rgba(122,158,142,0.25);
  border-radius: 20px; padding: 5px 12px; font-size: 0.6rem;
  color: var(--sage); letter-spacing: 0.05em; cursor: pointer;
  flex-shrink: 0; position: relative; transition: all 0.2s;
}
.hdr-weather:hover { background: var(--sage); color: white; }
.hdr-weather .weather-temp { font-weight: 600; margin-left: 4px; }
.hdr-weather:hover .weather-temp { color: white; }

/* Weather dropdown */
.weather-dropdown {
  position: absolute; top: calc(100% + 10px); right: 0;
  width: 320px; background: var(--snow);
  border: 1.5px solid var(--border); border-radius: var(--radius);
  box-shadow: 0 12px 40px rgba(0,0,0,0.1);
  z-index: 500; overflow: hidden;
  opacity: 0; pointer-events: none; transform: translateY(-8px);
  transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
}
.weather-dropdown.open { opacity: 1; pointer-events: all; transform: translateY(0); }

.weather-tabs {
  display: flex; overflow-x: auto;
  border-bottom: 1px solid var(--border);
  scrollbar-width: none;
}
.weather-tabs::-webkit-scrollbar { display: none; }
.weather-tab {
  flex-shrink: 0; padding: 8px 12px;
  font-size: 0.55rem; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--ink3); cursor: pointer; border-bottom: 2px solid transparent;
  transition: all 0.15s; white-space: nowrap;
}
.weather-tab.active { color: var(--sage); border-color: var(--sage); }
.weather-tab:hover:not(.active) { color: var(--ink2); }

.weather-panels { padding: 14px; }
.weather-panel { display: none; }
.weather-panel.active { display: block; }

.weather-city-name {
  font-family: 'Shippori Mincho', serif; font-size: 1rem; font-weight: 700;
  color: var(--ink); margin-bottom: 2px;
}
.weather-city-period { font-size: 0.58rem; color: var(--ink3); letter-spacing: 0.05em; margin-bottom: 12px; }

.weather-forecast {
  display: flex; gap: 4px; overflow-x: auto; padding-bottom: 4px;
  scrollbar-width: none;
}
.weather-forecast::-webkit-scrollbar { display: none; }

.wf-day {
  flex-shrink: 0; width: 64px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 8px 6px; text-align: center;
  transition: all 0.15s; cursor: default;
}
.wf-day:hover { background: var(--snow); border-color: var(--border2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.07); }
.wf-day-name { font-size: 0.48rem; color: var(--ink3); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 4px; }
.wf-icon { font-size: 1.1rem; margin-bottom: 4px; }
.wf-max { font-size: 0.7rem; font-weight: 600; color: var(--ink); }
.wf-min { font-size: 0.55rem; color: var(--ink3); }
.wf-rain { font-size: 0.45rem; color: var(--sky); margin-top: 2px; }

.weather-summary {
  margin-top: 10px; padding: 8px 10px;
  background: var(--sage-l); border-radius: var(--radius-sm);
  font-size: 0.58rem; color: var(--ink2); line-height: 1.6;
}
.weather-source { font-size: 0.48rem; color: var(--ink3); margin-top: 8px; text-align: right; }

/* Progress dots */
.hdr-progress { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.progress-label { font-size: 0.58rem; color: var(--ink3); letter-spacing: 0.08em; text-transform: uppercase; white-space: nowrap; }
.progress-dots { display: flex; gap: 4px; align-items: center; }
.pdot { width: 7px; height: 7px; border-radius: 50%; background: var(--border2); transition: all 0.3s; cursor: pointer; border: none; }
.pdot.active { background: var(--blush); transform: scale(1.3); }

.btn-toggle {
  display: none; background: var(--surface2); border: 1px solid var(--border);
  color: var(--ink2); padding: 7px 14px; font-family: 'Outfit', sans-serif;
  font-size: 0.65rem; letter-spacing: 0.06em; cursor: pointer;
  border-radius: 20px; transition: all 0.2s; flex-shrink: 0;
  align-items: center; gap: 6px;
}
.btn-toggle:hover { background: var(--blush-l); border-color: var(--blush); color: var(--blush); }

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex: 1; display: flex; overflow: hidden; }
#map { flex: 1; min-width: 0; z-index: 1; }

/* â”€â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  width: var(--panel); flex-shrink: 0;
  display: flex; flex-direction: column;
  background: var(--surface); border-left: 1px solid var(--border);
  overflow: hidden; transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
}
.panel-hdr {
  padding: 16px 18px 12px; border-bottom: 1px solid var(--border);
  flex-shrink: 0; display: flex; align-items: flex-start;
  justify-content: space-between; gap: 10px;
}
.panel-title { font-family: 'Shippori Mincho', serif; font-size: 1rem; font-weight: 600; color: var(--ink); margin-bottom: 2px; }
.panel-sub { font-size: 0.58rem; color: var(--ink3); letter-spacing: 0.06em; }
.budget-pill {
  background: var(--amber-l); border: 1px solid rgba(184,146,74,0.25);
  border-radius: 20px; padding: 4px 10px; text-align: right; flex-shrink: 0;
}
.budget-amount { font-family: 'Shippori Mincho', serif; font-size: 0.85rem; font-weight: 600; color: var(--amber); display: block; }
.budget-label { font-size: 0.52rem; color: var(--ink3); letter-spacing: 0.06em; }

/* â”€â”€â”€ SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scroll {
  flex: 1; overflow-y: auto; padding: 12px;
  display: flex; flex-direction: column; gap: 8px;
  scrollbar-width: thin; scrollbar-color: var(--border2) transparent;
}

/* â”€â”€â”€ TRANSIT SEPARATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sep { display: flex; align-items: center; gap: 8px; padding: 4px 2px; margin: 2px 0; }
.sep-line { flex: 1; height: 1px; background: var(--border); }
.sep-chip {
  display: flex; align-items: center; gap: 5px;
  background: var(--sky-l); border: 1px solid rgba(122,155,181,0.2);
  border-radius: 20px; padding: 3px 10px; font-size: 0.55rem;
  color: var(--sky); letter-spacing: 0.07em; text-transform: uppercase; white-space: nowrap;
}

/* â”€â”€â”€ STOP CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stop-card {
  background: var(--snow); border: 1.5px solid var(--border);
  border-radius: var(--radius);
  transition: border-color 0.2s, box-shadow 0.2s;
  cursor: pointer;
  animation: slideIn 0.45s cubic-bezier(0.22,1,0.36,1) both;
}
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.stop-card:hover { border-color: var(--border2); box-shadow: 0 4px 20px rgba(0,0,0,0.07); transform: translateY(-1px); }
.stop-card.active { border-color: var(--blush); box-shadow: 0 6px 28px rgba(196,126,126,0.15); }

.card-strip { height: 4px; border-radius: var(--radius) var(--radius) 0 0; overflow: hidden; }

.card-head-row {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 10px; padding: 13px 14px 10px;
}
.card-num-city { flex: 1; min-width: 0; }
.card-num { font-size: 0.5rem; font-weight: 600; letter-spacing: 0.16em; text-transform: uppercase; margin-bottom: 3px; opacity: 0.6; }
.card-city { font-family: 'Shippori Mincho', serif; font-size: 1.05rem; font-weight: 700; color: var(--ink); line-height: 1.2; }

.card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.card-dates { font-size: 0.58rem; color: var(--ink3); letter-spacing: 0.04em; text-align: right; line-height: 1.5; }

.card-expand-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 50%; width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; color: var(--ink3); cursor: pointer;
  transition: all 0.2s; flex-shrink: 0; line-height: 1;
  user-select: none;
}
.stop-card.active .card-expand-btn { background: var(--blush-l); border-color: rgba(196,126,126,0.3); color: var(--blush); }
.card-expand-btn .arrow { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); display: inline-block; }
.stop-card.expanded .card-expand-btn .arrow { transform: rotate(180deg); }

.card-quick {
  display: flex; align-items: center; gap: 6px;
  padding: 0 14px 11px; flex-wrap: wrap;
}
.quick-chip {
  display: flex; align-items: center; gap: 4px;
  font-size: 0.57rem; padding: 3px 8px; border-radius: 20px;
  letter-spacing: 0.03em; font-weight: 400; white-space: nowrap;
}

/* â”€â”€â”€ EXPANDABLE BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.42s cubic-bezier(0.4,0,0.2,1);
}

.stop-card.expanded .card-body {
  max-height: 9000px; /* large enough for any content */
  transition: max-height 0.6s cubic-bezier(0.4,0,0.2,1);
}

.card-body-inner {
  border-top: 1px solid var(--border);
  margin: 0 14px;
  padding: 12px 0 16px;
  display: flex; flex-direction: column; gap: 10px;
}

/* Lodging */
.lodge-title {
  font-size: 0.52rem; font-weight: 600; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--ink3); margin-bottom: 6px;
}
.lodge-options { display: flex; flex-direction: column; gap: 5px; }
.lodge-option {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 9px 10px;
  text-decoration: none; transition: all 0.18s; color: var(--ink);
}
.lodge-option:hover { border-color: var(--border2); background: var(--snow); transform: translateX(2px); }
.lodge-option.main-opt { border-left: 3px solid var(--sage); }
.lodge-option.alt-opt { border-left: 3px solid var(--lavender); opacity: 0.8; }
.lodge-option.alt-opt:hover { opacity: 1; }

.lodge-badge {
  font-size: 0.5rem; font-weight: 600; letter-spacing: 0.08em;
  text-transform: uppercase; padding: 2px 5px; border-radius: 4px; flex-shrink: 0;
}
.badge-main { background: var(--sage-l); color: var(--sage); }
.badge-alt { background: var(--lavender-l); color: var(--lavender); }

.lodge-name {
  font-size: 0.66rem; font-weight: 500; color: var(--ink2);
  flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.lodge-price { font-size: 0.62rem; font-weight: 600; color: var(--amber); flex-shrink: 0; }
.lodge-arrow { font-size: 0.6rem; color: var(--ink3); flex-shrink: 0; }

/* Detail rows */
.detail-row { display: flex; gap: 8px; align-items: flex-start; }
.detail-icon { width: 26px; height: 26px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
.detail-content { flex: 1; min-width: 0; }
.detail-label { font-size: 0.5rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 1px; }
.detail-value { font-size: 0.64rem; color: var(--ink2); line-height: 1.6; }

/* Activity pills */
.activity-pills { display: flex; flex-wrap: wrap; gap: 5px; }
.activity-pill {
  background: var(--sage-l); border: 1px solid rgba(122,158,142,0.2);
  border-radius: 20px; padding: 4px 10px; font-size: 0.58rem; color: var(--sage); letter-spacing: 0.04em;
}

/* Guide link */
.guide-link {
  display: inline-flex; align-items: center; gap: 5px; font-size: 0.58rem;
  color: var(--sky); text-decoration: none; border: 1px solid rgba(122,155,181,0.25);
  border-radius: 20px; padding: 4px 10px; background: var(--sky-l);
  transition: all 0.15s; width: fit-content;
}
.guide-link:hover { background: var(--sky); color: white; border-color: var(--sky); }

/* â”€â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.totals { flex-shrink: 0; background: var(--snow); border-top: 1px solid var(--border); padding: 14px 18px; }
.totals-title { font-size: 0.52rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink3); margin-bottom: 10px; }
.totals-rows { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
.total-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.62rem; }
.total-row .l { color: var(--ink3); white-space: nowrap; }
.total-row .v { color: var(--ink2); font-weight: 500; white-space: nowrap; }
.total-row .bar-wrap { flex: 1; margin: 0 10px; height: 3px; border-radius: 10px; background: var(--border); overflow: hidden; }
.total-row .bar-fill { height: 100%; border-radius: 10px; }
.totals-sum { display: flex; justify-content: space-between; align-items: baseline; padding-top: 10px; border-top: 1px solid var(--border); }
.totals-sum .l { font-family: 'Shippori Mincho', serif; font-size: 0.82rem; font-weight: 600; color: var(--ink); }
.totals-sum .v { font-family: 'Shippori Mincho', serif; font-size: 1.1rem; font-weight: 700; color: var(--amber); }
.totals-sum .sub { font-size: 0.55rem; color: var(--ink3); text-align: right; }

/* â”€â”€â”€ LEAFLET POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.leaflet-popup-content-wrapper {
  background: var(--snow); border: 1.5px solid var(--border);
  border-radius: var(--radius) !important; padding: 0 !important;
  box-shadow: 0 12px 40px rgba(0,0,0,0.12);
  font-family: 'Outfit', sans-serif; color: var(--ink); overflow: hidden;
  min-width: 260px;
}
.leaflet-popup-tip-container { display: none; }
.leaflet-popup-content { margin: 0; padding: 0; width: auto !important; }

/* Popup photo */
.pop-photo {
  width: 100%; height: 130px; object-fit: cover;
  display: block; background: var(--border);
}
.pop-photo-placeholder {
  width: 100%; height: 130px;
  background: linear-gradient(135deg, var(--sage-l), var(--sky-l));
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem;
}

.pop-header { padding: 12px 16px 9px; border-bottom: 1px solid var(--border); }
.pop-city { font-family: 'Shippori Mincho', serif; font-size: 1.05rem; font-weight: 700; color: var(--ink); margin-bottom: 2px; }
.pop-dates { font-size: 0.6rem; color: var(--ink3); letter-spacing: 0.06em; }
.pop-body { padding: 10px 16px 14px; display: flex; flex-direction: column; gap: 7px; }
.pop-row { display: flex; gap: 8px; font-size: 0.63rem; align-items: flex-start; }
.pop-row .l { color: var(--ink3); min-width: 55px; flex-shrink: 0; font-size: 0.58rem; letter-spacing: 0.05em; }
.pop-row .r { color: var(--ink2); line-height: 1.5; }
.pop-row a { color: var(--sage); text-decoration: none; }
.pop-row a:hover { text-decoration: underline; }

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 800px) {
  :root { --panel: 100vw; }
  .btn-toggle { display: flex; }
  .hdr-meta, .hdr-sep, .hdr-progress { display: none; }

  .panel {
    position: fixed;
    right: 0; top: var(--hdr); bottom: 0;
    transform: translateX(100%);
    box-shadow: -8px 0 32px rgba(0,0,0,0.15);
    z-index: 300;
  }
  .panel.open { transform: translateX(0); }

  .weather-dropdown { right: -60px; width: 290px; }
}

@media (min-width: 801px) and (max-width: 1100px) {
  :root { --panel: 300px; }
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-kanji">æ—¥æœ¬</span>
    <div class="logo-text">
      <span class="logo-main">Little Domo Very Arigato</span>
      <span class="logo-sub">Voyage au Japon Â· Nov â€” DÃ©c 2026</span>
    </div>
  </div>
  <div class="hdr-sep"></div>
  <div class="hdr-meta">
    <strong>Toulouse â†’ Tokyo</strong><br>
    18 nov â€” 05 dÃ©c Â· 4 personnes
  </div>
  <div class="hdr-spacer"></div>

  <!-- Weather widget -->
  <div class="hdr-weather" id="weatherToggle" onclick="toggleWeather(event)">
    ğŸ‚ MÃ©tÃ©o Japon <span class="weather-temp">10â€“18Â°C</span>
    <span>â–¾</span>
    <div class="weather-dropdown" id="weatherDropdown">
      <div class="weather-tabs" id="weatherTabs"></div>
      <div class="weather-panels" id="weatherPanels"></div>
    </div>
  </div>

  <!-- Stop navigator dots -->
  <div class="hdr-progress">
    <span class="progress-label">Ã‰tapes</span>
    <div class="progress-dots" id="dots"></div>
  </div>

  <button class="btn-toggle" onclick="togglePanel()" id="toggleBtn">â˜° Ã‰tapes</button>
</header>

<div class="main">
  <div id="map"></div>
  <div class="panel" id="panel">
    <div class="panel-hdr">
      <div>
        <div class="panel-title">ItinÃ©raire</div>
        <div class="panel-sub">7 Ã©tapes Â· Cliquer pour dÃ©plier</div>
      </div>
      <div class="budget-pill">
        <span class="budget-amount">4 122 â‚¬</span>
        <span class="budget-label">total Â· 1 031 â‚¬/pers</span>
      </div>
    </div>
    <div class="scroll" id="list"></div>
    <div class="totals">
      <div class="totals-title">RÃ©partition du budget</div>
      <div class="totals-rows">
        <div class="total-row">
          <span class="l">ğŸ  Logements</span>
          <div class="bar-wrap"><div class="bar-fill" style="width:51%;background:var(--sage)"></div></div>
          <span class="v">2 086 â‚¬</span>
        </div>
        <div class="total-row">
          <span class="l">ğŸš„ Transports</span>
          <div class="bar-wrap"><div class="bar-fill" style="width:45%;background:var(--sky)"></div></div>
          <span class="v">1 836 â‚¬</span>
        </div>
        <div class="total-row">
          <span class="l">ğŸ¡ ActivitÃ©s</span>
          <div class="bar-wrap"><div class="bar-fill" style="width:5%;background:var(--blush)"></div></div>
          <span class="v">200 â‚¬</span>
        </div>
      </div>
      <div class="totals-sum">
        <span class="l">Total estimÃ©</span>
        <div>
          <div class="v">4 122 â‚¬</div>
          <div class="sub">1 030,50 â‚¬ / personne</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STOPS = [
  {
    id:0, type:'transit',
    city:'Toulouse-Blagnac', dates:'Mer 18 nov 2026',
    lat:43.6291, lng:1.3638,
    note:'DÃ©part vers le Japon âœˆ',
    color: '#7a9bb5'
  },
  {
    id:1, type:'stop',
    city:'Tokyo', dates:'Jeu 19 â€“ Sam 21 nov',
    lat:35.6762, lng:139.6503,
    color:'#c47e7e',
    logement:'Logement low cost',
    lienLog:'https://www.airbnb.fr/rooms/1551807196383187760?adults=4&check_in=2026-11-19&check_out=2026-11-22',
    altLog:'Ca a de la gueule',
    lienAlt:'https://www.airbnb.fr/rooms/1546827694877987513?adults=4&check_in=2026-11-19&check_out=2026-11-22',
    prix:363, prixP:90.75,
    activites:['Tsukiji','Shibuya crossing','Shinjuku'],
    note: '3 nuits Â· Premier contact avec Tokyo',
    reserved:false,
    photoQuery:'Tokyo Japan cityscape',
    weatherKey:'tokyo'
  },
  {
    id:2, type:'stop',
    city:'Kanazawa', dates:'Dim 22 nov',
    lat:36.5613, lng:136.6562,
    color:'#9a8ab5',
    lienVille:'https://www.kanpai.fr/kanazawa',
    logement:'Moyen cost',
    lienLog:'https://www.airbnb.fr/rooms/28918502?adults=4&check_in=2026-11-22&check_out=2026-11-23',
    altLog:'Marrant',
    lienAlt:'https://www.airbnb.fr/rooms/711357847961458309?adults=4&check_in=2026-11-22&check_out=2026-11-23',
    prix:250, prixP:62.5,
    activites:['Jardins Kenroku-en','Quartier Higashi Chaya','Peut-Ãªtre 2 jours ?'],
    duree:'2h30 depuis Tokyo', trajet:90,
    note:'1 nuit Â· Ville des arts et du Noh',
    reserved:false,
    photoQuery:'Kanazawa Japan gardens',
    weatherKey:'kanazawa'
  },
  {
    id:3, type:'stop',
    city:'Takayama', dates:'Lun 23 â€“ Mar 24 nov',
    lat:36.1461, lng:137.2523,
    color:'#b8924a',
    lienVille:'https://www.kanpai.fr/takayama',
    logement:"C'est joli",
    lienLog:'https://www.booking.com/hotel/jp/ryokufuen-kiyoharu.fr.html?checkin=2026-11-23&checkout=2026-11-25&group_adults=4',
    altLog:'Lave-linge + sÃ¨che-linge',
    lienAlt:'https://www.airbnb.fr/rooms/1498316738993785321?adults=4&check_in=2026-11-23&check_out=2026-11-25',
    prix:475, prixP:118.75,
    activites:['Shirakawa-go','Reco kinÃ©','Vieux quartier Sanmachi'],
    duree:'1h15 + 50min (via Shirakawa)', trajet:30,
    note:'2 nuits Â· Village de montagne',
    reserved:false,
    photoQuery:'Takayama Japan traditional town',
    weatherKey:'takayama'
  },
  {
    id:4, type:'stop',
    city:'Kyoto', dates:'Mer 25 â€“ Ven 27 nov',
    lat:35.0116, lng:135.7681,
    color:'#7a9e8e',
    logement:'Lave-linge',
    lienLog:'https://www.airbnb.fr/rooms/14239019?adults=4&check_in=2026-11-25&check_out=2026-11-28',
    altLog:'SÃ¨che-linge',
    lienAlt:'https://www.airbnb.fr/rooms/39423656?adults=4&check_in=2026-11-25&check_out=2026-11-28',
    prix:250, prixP:62.5,
    activites:['Excursion Nara (A/R 1h30)','Fushimi Inari','Arashiyama'],
    duree:'Train 3h30', trajet:65,
    note:'3 nuits Â· Capitale impÃ©riale',
    reserved:false,
    photoQuery:'Kyoto Japan temple autumn',
    weatherKey:'kyoto'
  },
  {
    id:5, type:'stop',
    city:'Hiroshima', dates:'Sam 28 nov',
    lat:34.3853, lng:132.4553,
    color:'#7a9bb5',
    logement:'Prix sympa',
    lienLog:'https://www.airbnb.fr/rooms/1308373761672649274?adults=4&check_in=2026-11-28&check_out=2026-11-29',
    altLog:'Trad house',
    lienAlt:'https://www.airbnb.fr/rooms/990378354416365514?adults=4&check_in=2026-11-28&check_out=2026-11-29',
    prix:137, prixP:34.25,
    activites:['MÃ©morial de la Paix','Ãle de Miyajima','Torii flottant'],
    duree:'1h45 depuis Kyoto', trajet:70,
    note:'1 nuit Â· Histoire & mÃ©moire',
    reserved:false,
    photoQuery:'Hiroshima Peace Memorial Japan',
    weatherKey:'hiroshima'
  },
  {
    id:6, type:'stop',
    city:'Osaka', dates:'Dim 29 nov â€“ Mar 1 dÃ©c',
    lat:34.6937, lng:135.5023,
    color:'#c47e7e',
    logement:'Very economic',
    lienLog:'https://www.airbnb.fr/rooms/1547744592796575135?adults=4&check_in=2026-11-29&check_out=2026-12-02',
    altLog:'Fancy time (trÃ¨s cool)',
    lienAlt:'https://www.airbnb.fr/rooms/1547112363118924811?adults=4&check_in=2026-11-29&check_out=2026-12-02',
    prix:100, prixP:25,
    activites:['Universal Studio ğŸ¢','Dotonbori','Takoyaki','ChÃ¢teau d\'Osaka'],
    duree:'1h30 depuis Hiroshima', trajet:65,
    note:'3 nuits Â· Gastronomie & fun',
    reserved:false,
    photoQuery:'Osaka Japan Dotonbori night',
    weatherKey:'osaka'
  },
  {
    id:7, type:'stop',
    city:'Magome', dates:'Mer 2 dÃ©c',
    lat:35.5254, lng:137.5512,
    color:'#9a8ab5',
    lienVille:'https://www.voyagejapon.com/guide-japon/destination/magome',
    logement:'Ryokan O',
    lienLog:'https://www.airbnb.fr/rooms/45091164?adults=4&check_in=2026-12-02&check_out=2026-12-03',
    prix:140, prixP:35,
    activites:['Route Nakasendo','Shibu Onsen ?','Village Edo'],
    duree:'3h30â€“4h depuis Osaka', trajet:50,
    note:'1 nuit Â· Village Edo authentique',
    reserved:false,
    photoQuery:'Magome Japan historic village Nakasendo',
    weatherKey:'magome'
  },
  {
    id:8, type:'stop',
    city:'Tokyo', dates:'Jeu 3 â€“ Ven 4 dÃ©c',
    lat:35.6894, lng:139.6917,
    color:'#c47e7e',
    logement:'Correct',
    lienLog:'https://www.airbnb.fr/rooms/1504875726419858451?adults=4&check_in=2026-12-03&check_out=2026-12-05',
    prix:371, prixP:92.75,
    activites:['Shopping Shibuya','Akihabara','Derniers souvenirs','Harajuku'],
    duree:'3h depuis Magome', trajet:80,
    note:'2 nuits Â· Fin du voyage',
    reserved:false,
    photoQuery:'Tokyo Japan Shibuya night',
    weatherKey:'tokyo'
  },
  {
    id:9, type:'transit',
    city:'AÃ©roport de Tokyo', dates:'Sam 5 dÃ©c 2026',
    lat:35.5494, lng:139.7798,
    color:'#7a9bb5',
    note:'Retour vers la France ğŸ '
  }
];

// â”€â”€ WEATHER DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Moyennes historiques JMA (Japan Meteorological Agency) 1991â€“2020
// DonnÃ©es par date exacte de sÃ©jour, interpolÃ©es sur la fenÃªtre du voyage
// PrÃ©cipitations : jours de pluie moyens sur le mois / nb jours du mois
const WEATHER = {
  tokyo: {
    city: 'Tokyo',
    period: '19â€“21 nov & 3â€“4 dÃ©c Â· moy. historique JMA 1991â€“2020',
    summary: `Novembre est le mois le plus sec et ensoleillÃ© de l'automne Ã  Tokyo. Les tempÃ©ratures descendent progressivement : ~16Â°C mi-novembre, ~12Â°C dÃ©but dÃ©cembre. Feuillages (momiji) Ã  leur pic autour du 25â€“30 nov. TrÃ¨s peu de pluie.`,
    days: [
      { date:'19 nov', icon:'â˜€ï¸', max:17, min:10, rain:'8%',  sun:'6h' },
      { date:'20 nov', icon:'â˜€ï¸', max:17, min:10, rain:'8%',  sun:'6h' },
      { date:'21 nov', icon:'ğŸŒ¤', max:16, min:9,  rain:'10%', sun:'5h' },
      { date:'3 dÃ©c',  icon:'ğŸŒ¤', max:13, min:6,  rain:'12%', sun:'5h' },
      { date:'4 dÃ©c',  icon:'ğŸŒ¤', max:13, min:6,  rain:'12%', sun:'5h' },
    ]
  },
  kanazawa: {
    city: 'Kanazawa',
    period: '22 nov Â· moy. historique JMA 1991â€“2020',
    summary: `Kanazawa reÃ§oit les vents humides de la mer du Japon en novembre. Ciel souvent couvert, averses possibles. Les jardins Kenroku-en sont nÃ©anmoins splendides sous la brume automnale. PrÃ©voir impermÃ©able.`,
    days: [
      { date:'22 nov', icon:'ğŸŒ¥', max:14, min:7,  rain:'40%', sun:'2h' },
    ]
  },
  takayama: {
    city: 'Takayama',
    period: '23â€“24 nov Â· moy. historique JMA 1991â€“2020',
    summary: `En altitude (730m), Takayama est nettement plus froid. Fin novembre : premiÃ¨res gelÃ©es nocturnes quasi certaines. Neige possible mais rare. Les matins sont glacials et magnifiques. Superposez les couches !`,
    days: [
      { date:'23 nov', icon:'ğŸŒ¤', max:10, min:1,  rain:'15%', sun:'4h' },
      { date:'24 nov', icon:'ğŸŒ¥', max:9,  min:0,  rain:'20%', sun:'3h' },
    ]
  },
  kyoto: {
    city: 'Kyoto',
    period: '25â€“27 nov Â· moy. historique JMA 1991â€“2020',
    summary: `La fin novembre est le moment idÃ©al Ã  Kyoto : les Ã©rables (momiji) sont Ã  leur apogÃ©e de couleur rouge-orangÃ©. TempÃ©ratures agrÃ©ables en journÃ©e, fraÃ®ches le soir. Soleil frÃ©quent. Week-ends trÃ¨s frÃ©quentÃ©s.`,
    days: [
      { date:'25 nov', icon:'â˜€ï¸', max:16, min:8,  rain:'7%',  sun:'5h' },
      { date:'26 nov', icon:'â˜€ï¸', max:16, min:8,  rain:'7%',  sun:'5h' },
      { date:'27 nov', icon:'ğŸŒ¤', max:15, min:7,  rain:'10%', sun:'4h' },
    ]
  },
  hiroshima: {
    city: 'Hiroshima',
    period: '28 nov Â· moy. historique JMA 1991â€“2020',
    summary: `Hiroshima bÃ©nÃ©ficie d'un microclimat doux grÃ¢ce Ã  sa baie. Fin novembre : temps souvent clair et agrÃ©able, lÃ©gÃ¨rement plus chaud que Kyoto. Miyajima et son torii sont magnifiques sous le soleil d'automne.`,
    days: [
      { date:'28 nov', icon:'â˜€ï¸', max:17, min:9,  rain:'6%',  sun:'5h' },
    ]
  },
  osaka: {
    city: 'Osaka',
    period: '29 nov â€“ 1 dÃ©c Â· moy. historique JMA 1991â€“2020',
    summary: `Osaka fin novembre : doux et peu pluvieux. DÃ©but dÃ©cembre le froid s'installe plus nettement. Les soirÃ©es Ã  Dotonbori nÃ©cessitent un bon manteau. JournÃ©es ensoleillÃ©es idÃ©ales pour explorer.`,
    days: [
      { date:'29 nov', icon:'â˜€ï¸', max:17, min:9,  rain:'6%',  sun:'5h' },
      { date:'30 nov', icon:'ğŸŒ¤', max:16, min:8,  rain:'8%',  sun:'5h' },
      { date:'1 dÃ©c',  icon:'ğŸŒ¤', max:15, min:7,  rain:'10%', sun:'4h' },
    ]
  },
  magome: {
    city: 'Magome',
    period: '2 dÃ©c Â· moy. historique JMA 1991â€“2020',
    summary: `Village de montagne Ã  ~600m. DÃ©but dÃ©cembre : froid vif, possibilitÃ© de givre ou petite neige. L'ambiance du village Edo sous le froid est particuliÃ¨rement authentique. Le ryokan et son bain chaud seront bienvenus.`,
    days: [
      { date:'2 dÃ©c',  icon:'ğŸŒ¥', max:9,  min:1,  rain:'18%', sun:'3h' },
    ]
  }
};

// â”€â”€ PHOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Gradient fallbacks si image indisponible. Photos: Wikimedia Commons (domaine public)
// â”€â”€ PHOTOS par ville â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// IDs Unsplash stables + fallback couleur si image bloquÃ©e
const CITY_PHOTOS = {
  // Tokyo skyline nuit â€” photo-1540959733332-eab4deabeeaf (Unsplash, Trevor McKinnon)
  1: { url: 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&h=130&fit=crop&q=80', city: 'Tokyo', color: '#1a1f35' },
  // Kanazawa Kenroku-en â€” photo-1528360983277-13d401cdc186 (Unsplash)
  2: { url: 'https://images.unsplash.com/photo-1528360983277-13d401cdc186?w=400&h=130&fit=crop&q=80', city: 'Kanazawa', color: '#2d4a3e' },
  // Takayama vieille ville â€” photo-1598935898639-81586f7d2129 (Unsplash)
  3: { url: 'https://images.unsplash.com/photo-1598935898639-81586f7d2129?w=400&h=130&fit=crop&q=80', city: 'Takayama', color: '#3a2818' },
  // Kyoto Kinkaku-ji â€” photo-1493976040374-85c8e12f0c0e (Unsplash, Arisa Chattasa)
  4: { url: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400&h=130&fit=crop&q=80', city: 'Kyoto', color: '#1a3028' },
  // Hiroshima memorial â€” photo-1524413840807-0c3cb6fa808d (Unsplash)
  5: { url: 'https://images.unsplash.com/photo-1524413840807-0c3cb6fa808d?w=400&h=130&fit=crop&q=80', city: 'Hiroshima', color: '#2a4a6a' },
  // Osaka Dotonbori nuit â€” photo-1589452271712-64b8a66c7b71 (Unsplash)
  6: { url: 'https://images.unsplash.com/photo-1589452271712-64b8a66c7b71?w=400&h=130&fit=crop&q=80', city: 'Osaka', color: '#2a4a2a' },
  // Magome Nakasendo â€” photo-1528360983277-13d401cdc186 (village japonais)
  7: { url: 'https://images.unsplash.com/photo-1480796927426-f609979314bd?w=400&h=130&fit=crop&q=80', city: 'Magome', color: '#2a3a28' },
  // Tokyo Shibuya nuit â€” photo-1503899036084-c55cdd92da26 (Unsplash)
  8: { url: 'https://images.unsplash.com/photo-1503899036084-c55cdd92da26?w=400&h=130&fit=crop&q=80', city: 'Tokyo Â· Shibuya', color: '#0d0f1a' }
};

function makeCityIllustration(id) {
  const p = CITY_PHOTOS[id];
  if (!p) return '';
  const url = p.url;
  return `<div style="width:100%;height:130px;overflow:hidden;position:relative;background:${p.color}">
    <img
      src="${url}"
      alt="${p.city}"
      loading="lazy"
      style="width:100%;height:100%;object-fit:cover;display:block"
      onerror="this.style.display='none'"
    />
    <div style="position:absolute;bottom:7px;right:10px;font-family:'Shippori Mincho',serif;font-size:0.6rem;color:rgba(255,255,255,0.85);letter-spacing:0.08em;text-shadow:0 1px 4px rgba(0,0,0,0.7)">${p.city}</div>
  </div>`;
}

// â”€â”€ WEATHER WIDGET BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stops = STOPS.filter(s => s.type === 'stop');
const weatherKeys = [...new Set(stops.map(s => s.weatherKey).filter(Boolean))];
const tabsEl = document.getElementById('weatherTabs');
const panelsEl = document.getElementById('weatherPanels');

weatherKeys.forEach((key, idx) => {
  const w = WEATHER[key];
  if (!w) return;

  // Tab
  const tab = document.createElement('div');
  tab.className = 'weather-tab' + (idx === 0 ? ' active' : '');
  tab.textContent = w.city;
  tab.dataset.key = key;
  tab.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll('.weather-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.weather-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('wp-' + key).classList.add('active');
  };
  tabsEl.appendChild(tab);

  // Panel
  const panel = document.createElement('div');
  panel.className = 'weather-panel' + (idx === 0 ? ' active' : '');
  panel.id = 'wp-' + key;

  const days = w.days.map(d => `
    <div class="wf-day">
      <div class="wf-day-name">${d.date}</div>
      <div class="wf-icon">${d.icon}</div>
      <div class="wf-max">${d.max}Â°</div>
      <div class="wf-min">${d.min}Â°</div>
      <div class="wf-rain">â˜” ${d.rain}</div>
      ${d.sun ? `<div class="wf-rain" style="color:var(--amber)">â˜€ï¸ ${d.sun}</div>` : ''}
    </div>
  `).join('');

  panel.innerHTML = `
    <div class="weather-city-name">${w.city}</div>
    <div class="weather-city-period">${w.period}</div>
    <div class="weather-forecast">${days}</div>
    <div class="weather-summary">${w.summary}</div>
    <div class="weather-source">â˜… DonnÃ©es historiques Â· climatologie japonaise</div>
  `;
  panelsEl.appendChild(panel);
});

function toggleWeather(e) {
  e.stopPropagation();
  const dd = document.getElementById('weatherDropdown');
  dd.classList.toggle('open');
}
document.addEventListener('click', () => {
  document.getElementById('weatherDropdown').classList.remove('open');
});

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl: false });
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: 'Â©OpenStreetMap Â©CARTO', maxZoom: 19
}).addTo(map);

const jpStops = STOPS.filter(s => s.type === 'stop');
map.fitBounds(L.latLngBounds(jpStops.map(s => [s.lat, s.lng])), { padding: [55, 60] });

// â”€â”€ ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeIcon(label, color, active, isTransit) {
  const size = isTransit ? 22 : 32;
  const bg = active ? color : '#ffffff';
  const textColor = active ? '#ffffff' : color;
  const shadow = active ? `0 4px 16px ${color}55` : '0 2px 8px rgba(0,0,0,0.15)';

  return L.divIcon({
    className: '',
    html: `<div style="
      background:${bg};color:${textColor};
      width:${size}px;height:${size}px;
      display:flex;align-items:center;justify-content:center;
      font-family:'Outfit',sans-serif;
      font-size:${isTransit?'0.7':'0.68'}rem;
      font-weight:600;border:2px solid ${color};
      border-radius:50%;box-shadow:${shadow};
      transition:all 0.25s;letter-spacing:0;
    ">${label}</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2 - 4]
  });
}

// â”€â”€ POPUP with photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePopup(s, stopIdx) {
  const photoHtml = makeCityIllustration(s.id);

  const logHTML = s.logement
    ? `<div class="pop-row">
        <span class="l">Logement</span>
        <span class="r">${s.lienLog ? `<a href="${s.lienLog}" target="_blank">${s.logement}</a>` : s.logement}${s.altLog ? ` Â· <a href="${s.lienAlt||'#'}" target="_blank">${s.altLog}</a>` : ''}</span>
       </div>` : '';
  const prixHTML = s.prix
    ? `<div class="pop-row"><span class="l">Prix nuit</span><span class="r">${s.prix} â‚¬ <span style="opacity:0.5">(${s.prixP} â‚¬/pers)</span></span></div>` : '';
  const actHTML = s.activites?.length
    ? `<div class="pop-row"><span class="l">ActivitÃ©s</span><span class="r">${s.activites.join(' Â· ')}</span></div>` : '';
  const trajetHTML = s.duree
    ? `<div class="pop-row"><span class="l">Trajet</span><span class="r">${s.duree}${s.trajet ? ` Â· ${s.trajet} â‚¬/pers` : ''}</span></div>` : '';
  const noteHTML = s.note
    ? `<div class="pop-row"><span class="l">Note</span><span class="r" style="font-style:italic;opacity:0.7">${s.note}</span></div>` : '';

  return `
    ${photoHtml}
    <div class="pop-header">
      <div style="width:100%;height:3px;border-radius:10px;background:${s.color||'#ccc'};margin-bottom:8px"></div>
      <div class="pop-city">${s.city}</div>
      <div class="pop-dates">${s.dates || ''}</div>
    </div>
    <div class="pop-body">${logHTML}${prixHTML}${actHTML}${trajetHTML}${noteHTML}</div>`;
}

// â”€â”€ MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lMarkers = [];
let num = 0;
let activeIdx = null;
let expandedIdx = null;

STOPS.forEach((s, i) => {
  const isT = s.type === 'transit';
  if (!isT) num++;
  const lbl = isT ? 'âœˆ' : String(num);
  const m = L.marker([s.lat, s.lng], {
    icon: makeIcon(lbl, s.color || '#999', false, isT)
  }).addTo(map).bindPopup(makePopup(s, i), { maxWidth: 300, className: '' });
  m.on('click', () => activateStop(i));
  lMarkers.push({ m, lbl, isT });
});

// Route
L.polyline(STOPS.filter(s=>s.lat).map(s=>[s.lat,s.lng]), {
  color: '#b8924a', weight: 1.5, opacity: 0.3, dashArray: '5 9'
}).addTo(map);

// â”€â”€ DOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dotsEl = document.getElementById('dots');
const stopIndices = STOPS.map((s,i)=>s.type==='stop'?i:null).filter(x=>x!==null);
stopIndices.forEach((si) => {
  const d = document.createElement('button');
  d.className = 'pdot';
  d.title = STOPS[si].city;
  d.style.background = STOPS[si].color;
  d.style.opacity = '0.35';
  d.onclick = (e) => { e.stopPropagation(); activateStop(si); };
  d.id = `dot-${si}`;
  dotsEl.appendChild(d);
});

// â”€â”€ SIDEBAR BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const list = document.getElementById('list');
let sideN = 0;

STOPS.forEach((s, i) => {
  if (s.type === 'transit') {
    const sep = document.createElement('div');
    sep.className = 'sep';
    sep.innerHTML = `
      <div class="sep-line"></div>
      <div class="sep-chip">âœˆ ${s.city}</div>
      <div class="sep-line"></div>`;
    list.appendChild(sep);
    return;
  }

  sideN++;
  const card = document.createElement('div');
  card.className = 'stop-card';
  card.id = `c${i}`;
  card.style.animationDelay = `${sideN * 0.07}s`;

  // Quick chips
  const qChips = [];
  if (s.prix) qChips.push(`<span class="quick-chip" style="background:${s.color}18;color:${s.color};border:1px solid ${s.color}30">ğŸ  ${s.prixP} â‚¬/pers</span>`);
  if (s.trajet) qChips.push(`<span class="quick-chip" style="background:var(--sky-l);color:var(--sky);border:1px solid rgba(122,155,181,0.2)">ğŸš„ ${s.duree?.split(' ')[0]}</span>`);
  if (s.activites?.length) qChips.push(`<span class="quick-chip" style="background:var(--sage-l);color:var(--sage);border:1px solid rgba(122,158,142,0.2)">ğŸ“ ${s.activites.length} activitÃ©${s.activites.length>1?'s':''}</span>`);

  // Weather chip
  if (s.weatherKey && WEATHER[s.weatherKey]) {
    const w = WEATHER[s.weatherKey];
    const avg = Math.round(w.days.reduce((a,d) => a + (d.max+d.min)/2, 0) / w.days.length);
    qChips.push(`<span class="quick-chip" style="background:var(--amber-l);color:var(--amber);border:1px solid rgba(184,146,74,0.2)">ğŸŒ¡ ~${avg}Â°C</span>`);
  }

  // Lodge options
  const mainOpt = s.logement ? `
    <a class="lodge-option main-opt" href="${s.lienLog||'#'}" target="_blank" onclick="event.stopPropagation()">
      <span class="lodge-badge badge-main">Choix 1</span>
      <span class="lodge-name">${s.logement}</span>
      ${s.prix ? `<span class="lodge-price">${s.prix} â‚¬</span>` : ''}
      <span class="lodge-arrow">â†’</span>
    </a>` : '';

  const altOpt = s.altLog ? `
    <a class="lodge-option alt-opt" href="${s.lienAlt||'#'}" target="_blank" onclick="event.stopPropagation()">
      <span class="lodge-badge badge-alt">Alt.</span>
      <span class="lodge-name">${s.altLog}</span>
      <span class="lodge-arrow">â†’</span>
    </a>` : '';

  // Activities
  const actPills = s.activites?.map(a => `<span class="activity-pill">${a}</span>`).join('') || '';

  // Trajet detail
  const trajetRow = s.duree ? `
    <div class="detail-row">
      <div class="detail-icon" style="background:var(--sky-l)">ğŸš„</div>
      <div class="detail-content">
        <div class="detail-label">Trajet</div>
        <div class="detail-value">${s.duree}${s.trajet ? ` Â· <strong>${s.trajet} â‚¬/pers</strong>` : ''}</div>
      </div>
    </div>` : '';

  // Note
  const noteRow = s.note ? `
    <div class="detail-row">
      <div class="detail-icon" style="background:var(--amber-l)">âœ¦</div>
      <div class="detail-content">
        <div class="detail-label">Note</div>
        <div class="detail-value" style="font-style:italic;opacity:0.8">${s.note}</div>
      </div>
    </div>` : '';

  // Weather mini
  let weatherMini = '';
  if (s.weatherKey && WEATHER[s.weatherKey]) {
    const w = WEATHER[s.weatherKey];
    const days5 = w.days.slice(0,5);
    const dayPills = days5.map(d => `
      <div style="text-align:center;padding:4px 6px;background:var(--surface2);border-radius:8px;font-size:0.55rem;">
        <div style="color:var(--ink3);letter-spacing:0.04em;white-space:nowrap">${d.date}</div>
        <div style="font-size:0.9rem;margin:2px 0">${d.icon}</div>
        <div style="font-weight:600;color:var(--ink)">${d.max}Â°</div>
        <div style="color:var(--ink3)">${d.min}Â°</div>
        <div style="font-size:0.45rem;color:var(--sky)">â˜”${d.rain}</div>
      </div>`).join('');
    weatherMini = `
      <div>
        <div class="lodge-title">MÃ©tÃ©o (historique)</div>
        <div style="display:flex;gap:4px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none">${dayPills}</div>
        <div style="font-size:0.55rem;color:var(--ink3);margin-top:6px;line-height:1.5">${w.summary}</div>
      </div>`;
  }

  // Guide
  const guideRow = s.lienVille ? `
    <a class="guide-link" href="${s.lienVille}" target="_blank" onclick="event.stopPropagation()">
      ğŸ—º Guide de ${s.city}
    </a>` : '';

  card.innerHTML = `
    <div class="card-strip" style="background:${s.color}"></div>
    <div class="card-head-row" onclick="toggleExpand(${i}, event)">
      <div class="card-num-city">
        <div class="card-num" style="color:${s.color}">Ã‰tape ${String(sideN).padStart(2,'0')}</div>
        <div class="card-city">${s.city}</div>
      </div>
      <div class="card-right">
        <div class="card-dates">${s.dates}</div>
        <div class="card-expand-btn">
          <span class="arrow">â–¾</span>
        </div>
      </div>
    </div>
    ${qChips.length ? `<div class="card-quick">${qChips.join('')}</div>` : ''}
    <div class="card-body">
      <div class="card-body-inner">
        ${(mainOpt || altOpt) ? `
          <div class="lodge-section">
            <div class="lodge-title">HÃ©bergement</div>
            <div class="lodge-options">${mainOpt}${altOpt}</div>
          </div>` : ''}
        ${actPills ? `
          <div>
            <div class="lodge-title">ActivitÃ©s</div>
            <div class="activity-pills">${actPills}</div>
          </div>` : ''}
        ${weatherMini}
        ${trajetRow}
        ${noteRow}
        ${guideRow}
      </div>
    </div>`;

  // Click on card body to activate map (but not on links or head-row which already handles expand)
  card.addEventListener('click', (e) => {
    if (!e.target.closest('.lodge-option') && !e.target.closest('.guide-link') && !e.target.closest('.card-head-row')) {
      activateStop(i);
    }
  });

  list.appendChild(card);
});

// â”€â”€ TOGGLE EXPAND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleExpand(idx, e) {
  if (e) e.stopPropagation();
  const card = document.getElementById(`c${idx}`);
  if (!card) return;

  // Close previously expanded card
  if (expandedIdx !== null && expandedIdx !== idx) {
    const prev = document.getElementById(`c${expandedIdx}`);
    if (prev) prev.classList.remove('expanded');
  }

  const wasExpanded = card.classList.contains('expanded');
  card.classList.toggle('expanded', !wasExpanded);
  expandedIdx = wasExpanded ? null : idx;

  if (!wasExpanded) {
    activateStop(idx);
    // After animation, scroll so the card header stays visible at top
    setTimeout(() => {
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 60);
  }
}

// â”€â”€ ACTIVATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function activateStop(idx) {
  if (activeIdx !== null && activeIdx !== idx) {
    document.getElementById(`c${activeIdx}`)?.classList.remove('active');
    const prev = lMarkers[activeIdx];
    if (prev) prev.m.setIcon(makeIcon(prev.lbl, STOPS[activeIdx].color||'#999', false, prev.isT));
    const prevDot = document.getElementById(`dot-${activeIdx}`);
    if (prevDot) { prevDot.classList.remove('active'); prevDot.style.opacity = '0.5'; }
  }

  activeIdx = idx;
  const s = STOPS[idx];

  // Activate card
  const card = document.getElementById(`c${idx}`);
  if (card) {
    card.classList.add('active');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Activate marker
  const lm = lMarkers[idx];
  if (lm) {
    lm.m.setIcon(makeIcon(lm.lbl, s.color||'#999', true, lm.isT));
    map.flyTo([s.lat, s.lng], s.type === 'transit' ? 8 : 11, { duration: 1.4, easeLinearity: 0.25 });
    setTimeout(() => lm.m.openPopup(), 900);
  }

  // Dots
  stopIndices.forEach(si => {
    const d = document.getElementById(`dot-${si}`);
    if (!d) return;
    d.classList.toggle('active', si === idx);
    d.style.opacity = si === idx ? '1' : '0.4';
    d.style.transform = si === idx ? 'scale(1.4)' : 'scale(1)';
  });

  // Close panel on mobile after selecting
  if (window.innerWidth <= 800) {
    setTimeout(() => {
      document.getElementById('panel').classList.remove('open');
      document.getElementById('toggleBtn').textContent = 'â˜° Ã‰tapes';
    }, 300);
  }
}

// â”€â”€ MOBILE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePanel() {
  const p = document.getElementById('panel');
  const open = p.classList.toggle('open');
  document.getElementById('toggleBtn').textContent = open ? 'âœ• Fermer' : 'â˜° Ã‰tapes';
}
</script>
</body>
</html>
